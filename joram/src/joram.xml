<?xml version="1.0" standalone="yes"?>

<project default="ship.joram" basedir=".">
  <!-- Initializes properties -->
  <target name="init">
    <!-- Creates the time stamp -->
    <tstamp/>
    <!-- Initializes the environment properties, uses ${env.name} -->
    <property environment="env"/>
  
    <!-- Gets the user defined properties from file -->
    <property file="build.properties"/>

    <!-- Initializes the directory structure properties -->
    <property name="src.dir" location="."/>
    <property name="obj.dir" location="../classes"/>
    <property name="lib.dir" location="../lib"/>
    <property name="doc.dir" location="../javadoc"/>
    <property name="licenses.dir" location="../licenses"/>
    <property name="releases.dir" location="../releases"/>

    <!-- Base classpath needed for execution -->
    <path id="base.class.path">
      <pathelement path="${java.class.path}/"/>
      <fileset dir="${lib.dir}">
        <include name="activation.jar"/>
        <include name="connector-1_5.jar"/>
        <include name="jakarta-regexp-1.2.jar"/>
        <include name="JCup.jar"/>
        <include name="jms.jar"/>
        <include name="jmxri.jar"/>
        <include name="jmxtools.jar"/>
        <include name="jndi.jar"/>
        <include name="jta.jar"/>
        <include name="log4j.jar"/>
        <include name="mail.jar"/>
	<include name="ow_monolog.jar" />
        <include name="soap.jar"/>
        <include name="xerces.jar"/>
      </fileset>
    </path>

    <!-- Project classpath needed for compilation -->
    <path id="project.class.path">
      <path refid="base.class.path"/>
      <pathelement path="${obj.dir}"/>
      <pathelement path="${additional.path}"/>
    </path>
  </target>

  <!-- Cleans all generated files -->
  <target name="clean" depends="init"
      description="--> Cleans all generated files">
    <delete dir="${obj.dir}"/>
    <delete dir="${doc.dir}"/>
    <!-- Deletes generated jar files -->
    <delete file="${lib.dir}/joram-client.jar" />
    <delete file="${lib.dir}/joram-connector.jar" />
    <delete file="${lib.dir}/joram-gui.jar" />
    <delete file="${lib.dir}/joram-mom.jar" />
    <delete file="${lib.dir}/joram-shared.jar" />
  </target>

  <!-- Prepares compilation phase -->
  <target name="prepare" depends="init">
    <!-- Creates the directory structure -->
    <mkdir dir="${obj.dir}"/>
    <mkdir dir="${doc.dir}"/>
  </target>

  <!-- Compilation phase -->
  <target name="compile" depends="prepare"
      description="--> Compiles Joram sources.">
    <javac srcdir="${src.dir}:${obj.dir}"
           destdir="${obj.dir}"
           debug="on"
           deprecation="${deprecation}"
           optimize="false"
           nowarn="${nowarn}"
           verbose="${verbose}">

      <classpath refid="project.class.path"/>

      <include name="fr/**/*.java"/>
      <include name="org/**/*.java"/>

      <!-- Requires kxml.jar -->
      <exclude name="fr/dyade/aaa/agent/conf/A3CMLKXmlWrapper.java"/>

      <!-- Exclude CVS directories -->
      <exclude name="fr/dyade/aaa/**/CVS/**/*.java"/>
    </javac>
  </target>

  <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
     - Joram specific build target
     - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
  <!-- JARS BUILDING -->
  <target name="ship.joram" depends="init,compile"
      description="--> Builds Joram server and client jars.">
    <jar jarfile="${lib.dir}/joram-shared.jar">
      <fileset dir="${obj.dir}">
        <include name="fr/dyade/aaa/jndi2/msg/*.class"/>
        <include name="fr/dyade/aaa/jndi2/soap/SoapObjectHelper.class"/>
        <include name="fr/dyade/aaa/jndi2/soap/SoapObjectItf.class"/>
        <include name="fr/dyade/aaa/util/*.class"/>
        <include name="org/objectweb/joram/shared/admin/*.class"/>
        <include name="org/objectweb/joram/shared/client/*.class"/>
        <include name="org/objectweb/joram/shared/excepts/*.class"/>
        <include name="org/objectweb/joram/shared/messages/*.class"/>
        <include name="org/objectweb/joram/shared/selectors/*.class"/>
      </fileset>
    </jar>
    <jar jarfile="${lib.dir}/joram-mom.jar">
      <fileset dir="${obj.dir}">
        <include name="fr/dyade/aaa/admin/*.class"/>
        <include name="fr/dyade/aaa/admin/cmd/*.class"/>
        <include name="fr/dyade/aaa/admin/script/*.class"/>
        <include name="fr/dyade/aaa/agent/*.class"/>
        <include name="fr/dyade/aaa/agent/conf/*.class"/>
        <include name="fr/dyade/aaa/agent/management/*.class"/>
        <include name="fr/dyade/aaa/jndi2/distributed/*.class"/>
        <include name="fr/dyade/aaa/jndi2/impl/*.class"/>
        <include name="fr/dyade/aaa/jndi2/server/*.class"/>
        <include name="fr/dyade/aaa/jndi2/soap/JndiSoapService.class"/>
        <include name="org/objectweb/joram/mom/*.class"/>
        <include name="org/objectweb/joram/mom/dest/*.class"/>
        <include name="org/objectweb/joram/mom/notifications/*.class"/>
        <include name="org/objectweb/joram/mom/proxies/*.class"/>
        <include name="org/objectweb/joram/mom/proxies/soap/*.class"/>
        <include name="org/objectweb/joram/mom/proxies/tcp/*.class"/>
        <include name="org/objectweb/joram/mom/util/*.class"/>
      </fileset>
    </jar>
    <jar jarfile="${lib.dir}/joram-client.jar">
      <fileset dir="${obj.dir}">
        <include name="fr/dyade/aaa/jndi2/client/*.class"/>
        <include name="fr/dyade/aaa/jndi2/scn/*.class"/>
        <include name="fr/dyade/aaa/jndi2/soap/SoapExt_*.class"/>
        <include name="org/objectweb/joram/client/jms/*.class"/>
        <include name="org/objectweb/joram/client/jms/admin/*.class"/>
        <include name="org/objectweb/joram/client/jms/local/*.class"/>
        <include name="org/objectweb/joram/client/jms/soap/*.class"/>
        <include name="org/objectweb/joram/client/jms/tcp/*.class"/>
      </fileset>
    </jar>
  </target>

  <!-- Builds a JORAM admin GUI jar. -->
  <target name="ship.gui" depends="init,compile"
      description="--> Builds Joram admin GUI jar.">
    <jar jarfile="${lib.dir}/joram-gui.jar">
      <fileset dir="${obj.dir}">
        <include name="org/objectweb/joram/client/tools/admin/*.class"/>
      </fileset>
      <fileset dir="${src.dir}">
        <include name="org/objectweb/joram/client/tools/admin/icons/*.png"/>
      </fileset>
    </jar>
  </target>

  <!-- Builds a JORAM connector jar. -->
  <target name="ship.connector" depends="ship.joram"
      description="--> Builds Joram connector jar.">
    <jar jarfile="${lib.dir}/joram-connector.jar">
      <fileset dir="${obj.dir}">
        <include name="org/objectweb/joram/client/connector/*.class"/>
      </fileset>
    </jar>
  </target>

  <!-- Builds a JORAM adapter. -->
  <target name="ship.adapter" depends="ship.connector"
          description="--> Builds JORAM adapter.">
    <mkdir dir="${lib.dir}/META-INF"/>
    <copy file="${src.dir}/org/objectweb/joram/client/connector/ra.xml"
          todir="${lib.dir}/META-INF"/>
    <jar jarfile="${lib.dir}/joram.rar">
      <fileset dir="${lib.dir}">
        <include name="jakarta-regexp-1.2.jar"/>
        <include name="joram-client.jar"/>
        <include name="joram-connector.jar"/>
        <include name="joram-mom.jar"/>
        <include name="joram-shared.jar"/>
        <include name="JCup.jar"/>
        <include name="ow_monolog.jar"/>
        <include name="xerces.jar"/>
        <include name="META-INF/ra.xml"/>
      </fileset>
    </jar>
    <delete dir="${lib.dir}/META-INF"/>
  </target>

  <!-- Builds a JORAM adapter for non collocated use. -->
  <target name="ship.remoteadapter" depends="ship.connector"
          description="--> Builds JORAM adapter for non collocated use.">
    <mkdir dir="${lib.dir}/META-INF"/>
    <copy file="${src.dir}/org/objectweb/joram/client/connector/ra-remote.xml"
          tofile="${lib.dir}/META-INF/ra.xml"/>
    <jar jarfile="${lib.dir}/joram.rar">
      <fileset dir="${lib.dir}">
        <include name="joram-shared.jar"/>
        <include name="joram-client.jar"/>
        <include name="joram-connector.jar"/>
        <include name="JCup.jar"/>
        <include name="ow_monolog.jar"/>
        <include name="META-INF/ra.xml"/>
      </fileset>
    </jar>
    <delete dir="${lib.dir}/META-INF"/>
  </target>

  <!-- Builds a JORAM adapter for JOnAS. -->
  <target name="ship.jonasadapter" depends="ship.connector"
          description="--> Builds JORAM adapter for JOnAS.">
    <mkdir dir="${lib.dir}/META-INF"/>
    <copy file="${src.dir}/org/objectweb/joram/client/connector/ra.xml"
          tofile="${lib.dir}/META-INF/ra.xml"/>
    <jar jarfile="${lib.dir}/joram.rar">
      <fileset dir="${lib.dir}">
        <include name="META-INF/ra.xml"/>
      </fileset>
    </jar>
    <delete dir="${lib.dir}/META-INF"/>
  </target>

  <!-- JAVADOC --> 
  <target name="javadoc" depends="prepare"
      description="--> Generates the Javadoc.">
    <javadoc packagenames="fr.dyade.aaa.*, org.objectweb.joram.*"
      sourcepath="${src.dir}"
      classpathref="project.class.path"
      defaultexcludes="yes"
      destdir="${doc.dir}"
      author="true"
      version="true"
      use="false"
      windowtitle="Joram Documentation">	   
      <doctitle><![CDATA[<h1>Joram Documentation</h1>]]></doctitle>
    </javadoc>
  </target>

  <!-- RELEASES -->
  <target name="releases" depends="release.src, release.jar"
    if="version"/>

  <target name="release.jar" depends="clean,ship.joram" if="version">
    <copy todir="../joram-${version}" includeEmptyDirs="no">
      <fileset dir="..">
	<exclude name="build.xml" />
	<exclude name="src/**" />
	<exclude name="classes/**" />
	<exclude name="lib/jmxri.jar" />
	<exclude name="lib/jmxtools.jar" />
	<exclude name="lib/kxml.jar" />
	<exclude name="lib/midpapi.jar" />
	<exclude name="releases/**" />
        <exclude name="samples/config/jmxable_a3servers.xml" />
	<exclude name="samples/src/kjoram/**" />
      </fileset>
    </copy>
    <tar tarfile="joram-${version}.tar"
      longfile="gnu"
      basedir=".."
      includes="joram-${version}/**" />
    <gzip zipfile="joram-${version}.tgz" src="joram-${version}.tar" />
    <delete file="joram-${version}.tar" /> 
    <delete dir="../joram-${version}" /> 
    <mkdir dir="${releases.dir}" />
    <move file="joram-${version}.tgz" todir="${releases.dir}" />
  </target>

  <target name="release.src" depends="clean" if="version">
    <copy todir="../joram-${version}-src" includeEmptyDirs="no">
      <fileset dir="..">
	<exclude name="build.xml" />
	<exclude name="src/fr/dyade/aaa/ns/**" />
	<exclude name="classes/**" />
        <exclude name="lib/jmxri.jar" />
	<exclude name="lib/jmxtools.jar" />
	<exclude name="lib/kxml.jar" />
	<exclude name="lib/midpapi.jar" />
	<exclude name="releases/**" />
	<exclude name="samples/config/jmxable_a3servers.xml" />
	<exclude name="samples/src/kjoram/**" />
	<exclude name="src/com/**" />
	<exclude name="src/kjoram.xml" />
      </fileset>
    </copy>
    <move file="../joram-${version}-src/src/joram.xml"
          tofile="../joram-${version}-src/src/build.xml" />
    <tar tarfile="joram-${version}-src.tar"
      longfile="gnu"
      basedir=".."
      includes="joram-${version}-src/**" />
    <gzip zipfile="joram-${version}-src.tgz" src="joram-${version}-src.tar" />
    <delete file="joram-${version}-src.tar" /> 
    <delete dir="../joram-${version}-src" /> 
    <mkdir dir="${releases.dir}" />
    <move file="joram-${version}-src.tgz" todir="${releases.dir}" />
  </target>
</project>
