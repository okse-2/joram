<?xml version="1.0" encoding="UTF-8"?>
<!--
 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 - JORAM: Java(TM) Open Reliable Asynchronous Messaging
 - Copyright (C) 2007 - ScalAgent Distributed Technologies
 - Copyright (C) 2007 - Bull S.A.S.
 -
 - This library is free software; you can redistribute it and/or
 - modify it under the terms of the GNU Lesser General Public
 - License as published by the Free Software Foundation; either
 - version 2.1 of the License, or any later version.
 -
 - This library is distributed in the hope that it will be useful,
 - but WITHOUT ANY WARRANTY; without even the implied warranty of
 - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 - Lesser General Public License for more details.
 -
 - You should have received a copy of the GNU Lesser General Public
 - License along with this library; if not, write to the Free Software
 - Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307
 - USA
 -
 - Initial developer(s): Guillaume Sauthier (Bull S.A.S)
 - Contributor(s):
 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 -->
<project name="Maven 2 - JORAM"
         default="install"
         xmlns:m2="urn:maven-artifact-ant">

  <!-- directory definition -->
  <property name="builder.dir" value="${basedir}/pom" />
  <property name="builder.lib.dir" value="${basedir}/lib" />
  <property name="output.dir" value="${basedir}/build" />
  <property name="src.dir" value="${basedir}/src" />
  <property name="output.tmp.dir" value="${output.dir}/tmp" />
  <property name="output.dist.dir" value="${basedir}/ship/lib" />

  <property file="${src.dir}/build.properties" />
  <property name="joram.version" value="${joram.major}.${joram.minor}.${joram.build}"/>

  <path id="build.lib.path">
    <fileset dir="${builder.lib.dir}">
      <include name="maven-artifact-ant-*-dep.jar" />
    </fileset>
  </path>

  <!-- m2:* elements loading -->
  <typedef resource="org/apache/maven/artifact/ant/antlib.xml"
           uri="urn:maven-artifact-ant">
    <classpath refid="build.lib.path" />
  </typedef>

  <!-- - - - - - - - - - - - - - - - - -
    target: init
    - - - - - - - - - - - - - - - - - -->
  <target name="init">
    <mkdir dir="${output.dir}" />
    <mkdir dir="${output.tmp.dir}" />
  </target>

  <!-- - - - - - - - - - - - - - - - - -
    target: update
    - - - - - - - - - - - - - - - - - -->
  <target name="update" depends="init">
    <copy todir="${output.tmp.dir}">
      <fileset dir="${builder.dir}" includes="*.pom" />
    </copy>
    <echo>"${joram.version}"</echo>
    <replace dir="${output.tmp.dir}"
             token="@VERSION@"
             value="${joram.version}" />

    <!-- ================================================ -->
    <!--                  JORAM POMs                    -->
    <!-- ================================================ -->
    <m2:pom id="parent.pom" file="${output.tmp.dir}/joram-parent.pom" />
    <m2:pom id="client.pom" file="${output.tmp.dir}/joram-client.pom" />
    <m2:pom id="connector.pom" file="${output.tmp.dir}/joram-connector.pom" />
    <m2:pom id="gui.pom" file="${output.tmp.dir}/joram-gui.pom" />
    <m2:pom id="mom.pom" file="${output.tmp.dir}/joram-mom.pom" />
    <m2:pom id="raconfig.pom" file="${output.tmp.dir}/joram-raconfig.pom" />
    <m2:pom id="config.pom" file="${output.tmp.dir}/joram-config.pom" />
    <m2:pom id="shared.pom" file="${output.tmp.dir}/joram-shared.pom" />
    <m2:pom id="rar.pom" file="${output.tmp.dir}/joram_ra_for_jonas.pom" />
  </target>

  <!-- =================================
    target: install SNAPSHOT
    ================================= -->
  <target name="install_snapshot"
  				description="--> Install SNAPSHOT artifacts">	
    <antcall target="install" inheritAll="true">
      <param name="joram.version" value="SNAPSHOT"/>
    </antcall>
  </target>
    
  <!-- =================================
    target: install
    ================================= -->
  <target name="install"
          depends="update"
          description="--> Install artifacts">

    <echo>*************************************</echo>

    <m2:install>
      <m2:pom refid="parent.pom" />
    </m2:install>

    <m2:install file="${output.dist.dir}/joram-client.jar">
      <m2:pom refid="client.pom" />
    </m2:install>

    <m2:install file="${output.dist.dir}/joram-connector.jar">
      <m2:pom refid="connector.pom" />
    </m2:install>

    <m2:install file="${output.dist.dir}/joram-gui.jar">
      <m2:pom refid="gui.pom" />
    </m2:install>

    <m2:install file="${output.dist.dir}/joram-mom.jar">
      <m2:pom refid="mom.pom" />
    </m2:install>

    <m2:install file="${output.dist.dir}/joram-raconfig.jar">
      <m2:pom refid="raconfig.pom" />
    </m2:install>

    <m2:install file="${output.dist.dir}/joram-config.jar">
      <m2:pom refid="config.pom" />
    </m2:install>

    <m2:install file="${output.dist.dir}/joram-shared.jar">
      <m2:pom refid="shared.pom" />
    </m2:install>

    <m2:install file="${output.dist.dir}/joram_for_jonas_ra.rar">
      <m2:pom refid="rar.pom" />
    </m2:install>

  </target>

  <!-- - - - - - - - - - - - - - - - - - - - - -
    - Deployment using Maven2 Ant tasks
    - - - - - - - - - - - - - - - - - - - - - -->
  <macrodef name="maven-deploy">
    <attribute name="pomrefid" />
    <attribute name="file" />
    <sequential>
      <m2:install-provider artifactId="wagon-ssh" version="1.0-alpha-7" />
      <!-- <m2:install-provider artifactId="wagon-file" version="1.0-beta-2" /> -->
      <m2:deploy file="@{file}" pomRefId="@{pomrefid}">
        <!-- may introduce here shared elements -->
      </m2:deploy>
    </sequential>
  </macrodef>

  <!-- =================================
    target: deploy SNAPSHOT
    ================================= -->
  <target name="deploy_snapshot"
  				description="--> Deploy SNAPSHOT artifacts">	
    <antcall target="deploy" inheritAll="true">
      <param name="joram.version" value="SNAPSHOT"/>
    </antcall>
  </target>
  
  <!-- =================================
    target: deploy
    ================================= -->
  <target name="deploy"
          depends="update"
          description="--> Deploy artifacts">

    <!-- Ask confirmation for deployment -->
    <input message="This will deploy JORAM ${joram.version} in the OFFICIAL OW2 maven repository. Are you sure ?"
           validargs="y,Y,n,N"
           addproperty="deploy.joram.input" />


    <!-- Set a property if the user has confirmed -->
    <condition property="deploy.joram">
      <or>
        <equals arg1="${deploy.joram.input}" arg2="y" />
        <equals arg1="${deploy.joram.input}" arg2="Y" />
      </or>
    </condition>

    <!-- Execute the internal target -->
    <antcall target="internal:deploy" />
  </target>

  <!-- - - - - - - - - - - - - - - - - -
          target: internal:deploy
         - - - - - - - - - - - - - - - - - -->
    <target name="internal:deploy" if="deploy.joram">

      <!-- Deploy the parent -->
      <m2:install-provider artifactId="wagon-ssh" version="1.0-alpha-7" />
      <m2:deploy>
        <m2:pom refid="parent.pom" />
      </m2:deploy>

      <maven-deploy pomRefId="client.pom"
                    file="${output.dist.dir}/joram-client.jar" />

      <maven-deploy pomRefId="config.pom"
                    file="${output.dist.dir}/joram-config.jar" />

      <maven-deploy pomRefId="connector.pom"
                    file="${output.dist.dir}/joram-connector.jar" />

      <maven-deploy pomRefId="gui.pom"
                    file="${output.dist.dir}/joram-gui.jar" />

      <maven-deploy pomRefId="mom.pom"
                    file="${output.dist.dir}/joram-mom.jar" />

      <maven-deploy pomRefId="raconfig.pom"
                    file="${output.dist.dir}/joram-raconfig.jar" />

      <maven-deploy pomRefId="shared.pom"
                    file="${output.dist.dir}/joram-shared.jar" />

      <maven-deploy pomRefId="rar.pom"
                    file="${output.dist.dir}/joram_for_jonas_ra.rar" />

    </target>

</project>

