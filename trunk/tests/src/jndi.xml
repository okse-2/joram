<?xml version="1.0"?>

<!DOCTYPE project [
    <!ENTITY common SYSTEM "file:./common.xml">
]>

<project default="tests.jndi.all" basedir=".">
  <!-- Includes generic stuff -->
  &common;

  <property file="env.properties" />

  <target name="init.src">
    <!-- Tests specific sources set -->
    <patternset id="specific">
      <include name="**/**/*.java" />
    </patternset>
  </target>

  <target name="tests.jndi.all" description=" --> launch all jndi2 tests">
    <ant dir="." antfile="jndi.xml" target="tests.jndi" />
    <ant dir="." antfile="jndi.xml" target="tests.nocoupling" />
  </target>

  <target name="tests.jndi" description=" --> launch all jndi tests">
    <ant dir="." antfile="jndi.xml" target="jndi.test1" />
    <ant dir="." antfile="jndi.xml" target="jndi.test2" />
    <ant dir="." antfile="jndi.xml" target="test.dtb" />
    <ant dir="." antfile="jndi.xml" target="test.dtb2" />
    <ant dir="." antfile="jndi.xml" target="test.dtb3" />
    <ant dir="." antfile="jndi.xml" target="test.dtb4" />
    <ant dir="." antfile="jndi.xml" target="test.dtb5" />
    <ant dir="." antfile="jndi.xml" target="test.dtb6" />
    <ant dir="." antfile="jndi.xml" target="test.dtb.crash" />
  </target>

  <target name="tests.nocoupling" description=" --> launch all jndi loose couplig tests">
    <ant dir="." antfile="jndi.xml" target="nocoupling.test1" />
    <ant dir="." antfile="jndi.xml" target="nocoupling.test2" />
    <ant dir="." antfile="jndi.xml" target="nocoupling.test3" />
    <ant dir="." antfile="jndi.xml" target="nocoupling.test4" />
    <ant dir="." antfile="jndi.xml" target="nocoupling.test5" />
  </target>


  <!--  ************ init and start ************ -->
  <target name="init.test.jndi2" depends="init">
    <delete dir="${test.dir}" />
    <mkdir dir="${test.dir}" />
    <copy file="a3config.dtd" todir="${test.dir}" />
    <copy file="jndi2/a3servers.xml" tofile="${test.dir}/a3servers.xml" />
    <copy file="jndi2/a3debug.cfg" tofile="${test.dir}/a3debug.cfg" />
  </target>

  <target name="init.test.jndi2.distributed" depends="init">
    <delete dir="${test.dir}" />
    <mkdir dir="${test.dir}" />
    <copy file="a3config.dtd" todir="${test.dir}" />
    <copy file="jndi2/distributed/a3servers.xml" tofile="${test.dir}/a3servers.xml" />
    <copy file="jndi2/a3debug.cfg" tofile="${test.dir}/a3debug.cfg" />
  </target>

  <target name="client.start">
    <java classname="${className}" failonerror="no" fork="yes" dir="${test.dir}">
      <classpath path="${project.class.path}" />
      <jvmarg line="-Dcom.sun.management.jmxremote -DMXServer=com.scalagent.jmx.JMXServer -Dframework.TestCase.TestId=0 -Dframework.TestCase.OutFile=${report.file} ${jvmargs}" />
      <!-- jvmarg line="-Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,server=y"/ -->
      <arg line="${arg}" />
    </java>
  </target>
  <!--  ************ init and start end ************ -->

  <!-- jndi2 test -->
  <target name="jndi.test1" depends="init.test.jndi2,compile" description=" --> test bind and unbind">
    <antcall target="client.start" inheritAll="true">
      <param name="className" value="jndi2.Test1" />
      <param name="transaction" value="fr.dyade.aaa.util.NTransaction" />
    </antcall>
  </target>

  <target name="jndi.test2" depends="init.test.jndi2,compile" description=" --> check exception when bind without create subcontext">
    <antcall target="client.start" inheritAll="true">
      <param name="className" value="jndi2.Test2" />
      <param name="transaction" value="fr.dyade.aaa.util.NTransaction" />
    </antcall>
  </target>

  <target name="tests.dtb" depends="test.dtb,test.dtb2,test.dtb3,test.dtb4,test.dtb5,test.dtb.crash" />

  <target name="test.dtb" depends="compile" description=" --> Test using createSubcontext">
    <antcall target="init.test.jndi2.distributed" inheritAll="true" />
    <antcall target="client.start" inheritAll="true">
      <param name="x" value="0" />
      <param name="className" value="jndi2.distributed.JndiTest" />
    </antcall>
  </target>

  <target name="test.dtb2" depends="compile" description=" --> Test createSubcontext method with multiple server">
    <antcall target="init.test.jndi2.distributed" inheritAll="true" />
    <antcall target="client.start" inheritAll="true">
      <param name="x" value="0" />
      <param name="className" value="jndi2.distributed.JndiTest2" />
    </antcall>
  </target>

  <target name="test.dtb3" depends="compile" description=" --> check create invalid subcontext throw a NameNotFoundException">
    <antcall target="init.test.jndi2.distributed" inheritAll="true" />
    <antcall target="client.start" inheritAll="true">
      <param name="x" value="0" />
      <param name="className" value="jndi2.distributed.JndiTest3" />
    </antcall>
  </target>

  <target name="test.dtb4" depends="compile" description=" --> Test lookup after restart server">
    <antcall target="init.test.jndi2.distributed" inheritAll="true" />
    <antcall target="client.start" inheritAll="true">
      <param name="x" value="0" />
      <param name="className" value="jndi2.distributed.JndiTest4" />
    </antcall>
  </target>

  <target name="test.dtb5" depends="compile" description=" --> Test suggested by Nigel Rantor">
    <antcall target="init.test.jndi2.distributed" inheritAll="true" />
    <antcall target="client.start" inheritAll="true">
      <param name="x" value="0" />
      <param name="className" value="jndi2.distributed.JndiTest5" />
    </antcall>
  </target>

  <target name="test.dtb6" depends="compile" description=" --> Test suggested by CS use-case">
    <antcall target="init.test.jndi2.distributed" inheritAll="true" />
    <antcall target="client.start" inheritAll="true">
      <param name="x" value="0" />
      <param name="className" value="jndi2.distributed.JndiTest6" />
    </antcall>
  </target>

  <target name="test.dtb.crash" depends="compile" description=" --> Check that the jndi still working after the recovery">
    <antcall target="init.test.jndi2.distributed" inheritAll="true" />
    <antcall target="client.start" inheritAll="true">
      <param name="x" value="0" />
      <param name="className" value="jndi2.distributed.JndiCrashTest" />
    </antcall>
  </target>
  <!-- end jndi2 test -->


  <!-- start test jndi2 with loose coupling -->
  <target name="init.test.nocoupling" depends="init">
    <delete dir="${test.dir}" />
    <mkdir dir="${test.dir}" />
    <copy file="a3config.dtd" todir="${test.dir}" />
    <copy file="jndi2/nocoupling/a3servers.xml" tofile="${test.dir}/a3servers.xml" />
    <copy file="jndi2/a3debug.cfg" tofile="${test.dir}/a3debug.cfg" />
  </target>

  <target name="nocoupling.test1" depends="compile" description=" --> Simple test : bind, rebind, createsubcontext, ... with 2 servers ">
    <antcall target="init.test.nocoupling" inheritAll="true" />
    <antcall target="client.start" inheritAll="true">
      <param name="x" value="0" />
      <param name="className" value="jndi2.nocoupling.JndiTest1" />
    </antcall>
  </target>

  <target name="nocoupling.test2" depends="compile" description=" --> test update jndi config when start a new server">
    <antcall target="init.test.nocoupling" inheritAll="true" />
    <antcall target="client.start" inheritAll="true">
      <param name="x" value="0" />
      <param name="className" value="jndi2.nocoupling.JndiTest2" />
    </antcall>
  </target>

  <target name="nocoupling.test3" depends="compile" description=" --> test jndi config when start a slave server without master">
    <antcall target="init.test.nocoupling" inheritAll="true" />
    <antcall target="client.start" inheritAll="true">
      <param name="x" value="0" />
      <param name="className" value="jndi2.nocoupling.JndiTest3" />
    </antcall>
  </target>

  <target name="nocoupling.test4" depends="compile" description=" --> test jndi config when start a slave server without master">
    <antcall target="init.test.nocoupling" inheritAll="true" />
    <antcall target="client.start" inheritAll="true">
      <param name="x" value="0"/>
      <param name="className" value="jndi2.nocoupling.JndiTest4"/>
    </antcall>
  </target>

  <target name="nocoupling.test5" depends="compile" description=" --> test jndi config when start a slave server without master">
    <antcall target="init.test.nocoupling" inheritAll="true" />
    <antcall target="client.start" inheritAll="true">
      <param name="x" value="0"/>
      <param name="className" value="jndi2.nocoupling.JndiTest5"/>
    </antcall>
  </target>

  <!-- end test jndi2 with loose coupling -->

</project>
