<!--<?xml version="1.0"?>

<!DOCTYPE project [
    <!ENTITY common SYSTEM "common.xml">
]>

<project default="tests" basedir=".">-->
  <target name="tests" depends="tests.a3base,tests.a3recovery,tests.a3perf" description=" --> launch test : base,recovery,perf"/>
  <target name="tests.http" depends="tests.http.base,tests.http.recovery" description=" -->  launch all http tests"/>

  <!--<target name="init.src">
    /// Tests specific sources set 
    <patternset id="specific">
      <include name="a3/**/*.java"/>
    </patternset>
  </target>-->

  <!-- Include generic part -->
 <!-- &common;-->

  <target name="admin" depends="init,compile">
    <antcall target="init.test" inheritAll="true">
      <param name="a3conf" value="a3/base/a3servers1.xml"/>
      <param name="a3debug" value="a3debug.cfg"/>
    </antcall>
    <java classname="fr.dyade.aaa.util.TcpSCAdmin"
          failonerror="no" fork="yes"
          dir="${test.dir}">
      <classpath path="${project.class.path}"/>
    </java>
  </target>

  <!--
    - Generic test launcher
    -->
  <target name="init.a3test" depends="init">
    <!-- Theses properties can be overidden by param defines in
      -  specific target.
     -->
    <property name="a3debug" value="a3debug.cfg"/>
    <property name="engine" value="fr.dyade.aaa.agent.Engine"/>
    <property name="network" value="fr.dyade.aaa.agent.SimpleNetwork"/>
    <property name="transaction" value="fr.dyade.aaa.util.NTransaction"/>
  </target>

  <target name="${postinit}"/>

  <target name="testx">
    <antcall target="init.test" inheritAll="true"/>
    <antcall target="${postinit}"/>
    <java classname="${package}.test${x}"
          failonerror="no" fork="yes"
          dir="${test.dir}">
      <classpath path="${project.class.path}"/>
      <jvmarg value="-Dframework.TestCase.TestId=${y}"/>
      <jvmarg value="-Dframework.TestCase.OutFile=${report.file}"/>
      <jvmarg line="-Dcom.sun.management.jmxremote -DMXServer=com.scalagent.jmx.JMXServer ${jvmargs}"/>
      <arg line="0 ./s0"/>
    </java>
  </target>
  <!--
    - -Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,server=y 
    -->

  <!--
    - Scalagent middleware base tests
    -->
  <target name="tests.a3base">
    <ant dir="." antfile="build.xml" target="test1.base"/>
    <ant dir="." antfile="build.xml" target="test2.base"/>
    <ant dir="." antfile="build.xml" target="test3.base"/>
    <ant dir="." antfile="build.xml" target="test4.base"/>
    <ant dir="." antfile="build.xml" target="test5.base"/>
    <ant dir="." antfile="build.xml" target="test6.base"/>
    <ant dir="." antfile="build.xml" target="test8.base"/>
    <ant dir="." antfile="build.xml" target="test9.base"/>
    <ant dir="." antfile="build.xml" target="test11.base"/>
    <ant dir="." antfile="build.xml" target="test12.base"/>
    <ant dir="." antfile="build.xml" target="test14.base"/>
    <ant dir="." antfile="build.xml" target="test15.base"/>
  </target>

  <target name="tests.http.base">
    <ant dir="." antfile="build.xml" target="test3.http.base"/>
    <ant dir="." antfile="build.xml" target="test4.http.base"/>
    <ant dir="." antfile="build.xml" target="test5.http.base"/>
    <ant dir="." antfile="build.xml" target="test5-3.http.base"/>
    <ant dir="." antfile="build.xml" target="test11.http.base"/>
    <ant dir="." antfile="build.xml" target="test15.base"/>
  </target>

  <!--
    - base test launcher
    -->
  <target name="testx.base">
    <antcall target="testx" inheritAll="true">
      <param name="package" value="a3.base"/>
    </antcall>
  </target>

  <!--
    - A simple Agent test
    -->
  <target name="test1.base" depends="init.a3test,compile">
    <!-- NTransaction -->
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="1"/>
      <param name="y" value="1"/>
      <param name="a3conf" value="a3/base/a3servers1.xml"/>
      <param name="jvmargs" value=""/>
    </antcall>
  </target>

  <!-- Another simple Agent test [Echo] -->
  <target name="test2.base" depends="init.a3test,compile">
    <!-- NTransaction -->
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="2"/>
      <param name="y" value="1"/>
      <param name="a3conf" value="a3/base/a3servers1.xml"/>
      <param name="jvmargs" value=""/>
    </antcall>
  </target>

  <!--
    - A distributed Echo test between 2 servers
    -->
  <target name="test3.base" depends="test3-1.base,test3-2.base"/>

  <target name="test3-1.base" depends="init.a3test,compile">
   <!-- 1 domain -->
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="3"/>
      <param name="y" value="1"/>
      <param name="a3conf" value="a3/base/a3servers2.xml"/>
      <param name="jvmargs" value="-DRouter=false"/>
    </antcall>
  </target>

  <!-- 1 domain with http network -->
  <target name="test3.http.base" depends="test3-1a.http.base,test3-1b.http.base,test3-2.http.base"/>
  <target name="test3-1a.http.base" depends="init.a3test,compile">
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="3"/>
      <param name="y" value="http-a"/>
      <param name="a3conf" value="a3/base/a3servers2e1.xml"/>
      <param name="jvmargs" value="-DRouter=false"/>
    </antcall>
  </target>
  <target name="test3-1b.http.base" depends="init.a3test,compile">
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="3"/>
      <param name="y" value="http-b"/>
      <param name="a3conf" value="a3/base/a3servers2e2.xml"/>
      <param name="jvmargs" value="-DRouter=false"/>
    </antcall>
  </target>

  <!-- 1 domain with http network -->
  <target name="postinit.https">
    <java classname="a3.base.genks"
          failonerror="no" fork="yes"
          dir="${test.dir}">
      <classpath path="${project.class.path}"/>
    </java>
    <replace file="${test.dir}/a3servers.xml"
             token="HttpNetwork" value="HttpsNetwork"/>
  </target>

  <target name="test3.https.base" depends="init.a3test,compile">
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="3"/>
      <param name="y" value="https-a"/>
      <param name="a3conf" value="a3/base/a3servers2e1.xml"/>
      <param name="jvmargs" value="-DRouter=false"/>
      <param name="postinit" value="postinit.https"/>
    </antcall>
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="3"/>
      <param name="y" value="https-b"/>
      <param name="a3conf" value="a3/base/a3servers2e2.xml"/>
      <param name="jvmargs" value="-DRouter=false"/>
      <param name="postinit" value="postinit.https"/>
    </antcall>
  </target>

  <!-- 1 domain with ssl network -->
  <target name="postinit.ssl">
    <java classname="a3.base.genks"
          failonerror="no" fork="yes"
          dir="${test.dir}">
      <classpath path="${project.class.path}"/>
    </java>
  </target>

  <target name="test3.ssl.base" depends="init.a3test,compile">
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="3"/>
      <param name="y" value="ssl-1"/>
      <param name="a3conf" value="a3/base/a3serversSSL1.xml"/>
      <param name="jvmargs" value=""/>
      <param name="postinit" value="postinit.ssl"/>
    </antcall>
  </target>

  <!-- Routing in a http domain -->
  <target name="test3-2.http.base" depends="init.a3test,compile">
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="3"/>
      <param name="y" value="2-http"/>
      <param name="a3conf" value="a3/base/a3servers4.http.xml"/>
      <param name="jvmargs" value="-DRouter=true"/>
    </antcall>
  </target>

  <!-- 2 servers in 2 different domain, with a router -->
  <target name="test3-2.base" depends="init.a3test,compile">
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="3"/>
      <param name="y" value="2"/>
      <param name="a3conf" value="a3/base/a3servers4.xml"/>
      <param name="jvmargs" value="-DRouter=true"/>
    </antcall>
  </target>

  <!--
    - A "graph" test between n servers
    -->
  <target name="test4.base" depends="test4-1.base,test4-2.base"/>

  <target name="test4-1.base" depends="init.a3test,compile">
    <!-- 1 server, NTransaction -->
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="4"/>
      <param name="y" value="1"/>
      <param name="a3conf" value="a3/base/a3servers1.xml"/>
      <param name="jvmargs" value="-DNbNode=1"/>
    </antcall>
  </target>

  <target name="test4-2.base" depends="init.a3test,compile">
    <!-- 2 servers, single domain -->
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="4"/>
      <param name="y" value="2"/>
      <param name="a3conf" value="a3/base/a3servers2.xml"/>
      <param name="jvmargs" value="-DNbNode=2"/>
    </antcall>
  </target>

  <target name="test4.http.base" depends="init.a3test,compile">
    <!-- 2 servers, single domain (HTTPNetwork) -->
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="4"/>
      <param name="y" value="2a"/>
      <param name="a3conf" value="a3/base/a3servers2e1.xml"/>
      <param name="jvmargs" value="-DNbNode=2"/>
    </antcall>
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="4"/>
      <param name="y" value="2b"/>
      <param name="a3conf" value="a3/base/a3servers2e2.xml"/>
      <param name="jvmargs" value="-DNbNode=2"/>
    </antcall>
  </target>

  <!--
    - A "ping-pong" test.
    -->
  <target name="test5.base" depends="test5-1.base,test5-2.base,test5-3.base"/>

  <!-- 1 server -->
  <target name="test5-1.base" depends="init.a3test,compile">
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="5"/>
      <param name="y" value="1"/>
      <param name="a3conf" value="a3/base/a3servers1.xml"/>
      <param name="jvmargs" value="-DRouter=false -DPong=0"/>
    </antcall>
  </target>

  <!-- 2 servers, 1 domain -->
  <target name="test5-2.base" depends="init.a3test,compile">
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="5"/>
      <param name="y" value="2"/>
      <param name="a3conf" value="a3/base/a3servers2.xml"/>
      <param name="jvmargs" value="-DRouter=false -DPong=1"/>
    </antcall>
  </target>

  <target name="test5.http.base" depends="init.a3test,compile">
    <!-- HttpNetwork -->
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="5"/>
      <param name="y" value="2a"/>
      <param name="a3conf" value="a3/base/a3servers2e1.xml"/>
      <param name="jvmargs" value="-DRouter=false -DPong=1"/>
    </antcall>
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="5"/>
      <param name="y" value="2b"/>
      <param name="a3conf" value="a3/base/a3servers2e1.xml"/>
      <param name="jvmargs" value="-DRouter=false -DPong=1"/>
    </antcall>
  </target>

  <!-- Routing in a http domain -->
  <target name="test5-3.http.base" depends="init.a3test,compile">
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="5"/>
      <param name="y" value="3-http"/>
      <param name="a3conf" value="a3/base/a3servers4.http.xml"/>
      <param name="jvmargs" value="-DRouter=true -DPong=1"/>
    </antcall>
  </target>

  <!-- 3 servers, 2 domain -->
  <target name="test5-3.base" depends="init.a3test,compile">
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="5"/>
      <param name="y" value="3"/>
      <param name="a3conf" value="a3/base/a3servers4.xml"/>
      <param name="jvmargs" value="-DRouter=true -DPong=1"/>
    </antcall>
  </target>

  <!--
    - Configuration tests
    -->
  <target name="test6.base" depends="test6-1.base,test6-2.base"/>

  <target name="test6-1.base" depends="init.a3test,compile">
    <!-- server S0 #0 inaccessible -->
    <antcall target="test6-x.base" inheritAll="true">
      <param name="x" value="1"/>
      <param name="a3conf" value="a3/base/a3serversCfg1.xml"/>
      <param name="exctype" value="java.lang.Exception"/>
      <param name="excmsg" value="Can't configure server"/>
      <param name="arg" value="1 ./s1"/>
    </antcall>
  </target>

  <target name="test6-2.base" depends="init.a3test,compile">
    <!-- Try to run twice an AgentServer -->
    <antcall target="init.test" inheritAll="true">
      <param name="a3conf" value="a3/base/a3servers1.xml"/>
    </antcall>
    <parallel>
        <java classname="fr.dyade.aaa.agent.AgentServer"
            failonerror="no" fork="yes"
            dir="${test.dir}">
           <classpath path="${project.class.path}"/>
           <arg line="0 ./s0"/>
        </java>
      <!--<antcall target="server.start" inheritAll="true">
        <param name="transaction" value="fr.dyade.aaa.util.NTransaction"/>
        <param name="sid" value="0"/>
      </antcall>-->
      <sequential>
        <sleep seconds="5"/>
        <java classname="a3.base.test6"
              failonerror="no" fork="yes"
              dir="${test.dir}">
          <classpath path="${project.class.path}"/>
          <jvmarg value="-Dframework.TestCase.TestId=99"/>
          <jvmarg value="-Dframework.TestCase.OutFile=${report.file}"/>
          <jvmarg value="-DExcType=java.lang.Exception"/>
          <jvmarg value="-DExcMsg=Can't start transaction manager"/>
          <arg line="0 ./s0"/>
        </java>
        <java classname="a3.base.askiller"
              failonerror="no" fork="yes"
              dir="${test.dir}">
          <classpath path="${project.class.path}"/>
          <arg line="8090"/>
        </java>
      </sequential>
    </parallel>
  </target>

  <target name="test6-x.base">
    <antcall target="init.test" inheritAll="true"/>
    <java classname="a3.base.test6"
          failonerror="no" fork="yes"
          dir="${test.dir}">
      <classpath path="${project.class.path}"/>
      <jvmarg value="-Dframework.TestCase.TestId=${x}"/>
      <jvmarg value="-Dframework.TestCase.OutFile=${report.file}"/>
      <jvmarg value="-DExcType=${exctype}"/>
      <jvmarg value="-DExcMsg=${excmsg}"/>
      <arg line="${arg}"/>
    </java>
  </target>

  <!--
    - Test a sendTo to an unkonwn server
    -->
  <target name="test8.base" depends="init.a3test,compile">
    <!-- NTransaction -->
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="8"/>
      <param name="y" value="1"/>
      <param name="a3conf" value="a3/base/a3servers8.xml"/>
      <param name="jvmargs" value=""/>
    </antcall>
  </target>

  <!--
    - Test the agent deletion, simple.
    -->
  <target name="test9.base" depends="init.a3test,compile">
    <!-- NTransaction -->
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="9"/>
      <param name="y" value="1"/>
      <param name="a3conf" value="a3/base/a3servers1.xml"/>
      <param name="jvmargs" value=""/>
    </antcall>
  </target>

  <!-- -->
  <target name="test11.base" depends="init.a3test,compile">
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="11"/>
      <param name="y" value="1"/>
      <param name="a3conf" value="a3/base/a3servers2.xml"/>
      <param name="jvmargs" value="-DSend=0 -DRecv=1 -Dbounce=99"/>
    </antcall>
  </target>


  <target name="test11.http.base"  depends="init.a3test,compile">
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="11"/>
      <param name="y" value="a"/>
      <param name="a3conf" value="a3/base/a3servers2e1.xml"/>
      <param name="jvmargs" value="-DSend=0 -DRecv=1 -Dbounce=99"/>
    </antcall>
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="11"/>
      <param name="y" value="b"/>
      <param name="a3conf" value="a3/base/a3servers2e2.xml"/>
      <param name="jvmargs" value="-DSend=0 -DRecv=1 -Dbounce=99"/>
    </antcall>
  </target>

  <!--  -->
  <target name="test12.base" depends="init.a3test,compile">
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="12"/>
      <param name="y" value="1"/>
      <param name="a3conf" value="a3/base/a3servers12.xml"/>
      <param name="jvmargs" value=""/>
    </antcall>
  </target>

  <target name="test13.base" depends="test13-1.base,test13-2.base"/>

  <target name="test13-1.base" depends="init.a3test,compile">
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="13"/>
      <param name="y" value="1"/>
      <param name="a3conf" value="a3/base/a3servers1.xml"/>
      <param name="jvmargs" value=""/>
    </antcall>
  </target>

  <target name="test13-2.base" depends="init.a3test,compile">
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="13"/>
      <param name="y" value="2"/>
      <param name="a3conf" value="a3/base/a3servers13.xml"/>
      <param name="jvmargs" value=""/>
    </antcall>
  </target>

  <!--
    - A test to verify that from field is correctly set in agentInitialize
    -->
  <target name="test14.base" depends="init.a3test,compile">
    <!-- NTransaction -->
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="14"/>
      <param name="y" value="1"/>
      <param name="a3conf" value="a3/base/a3servers2.xml"/>
      <param name="jvmargs" value=""/>
    </antcall>
  </target>

  <!--
    - A test using expiration time for notification.
    -->
  <target name="test15.base" depends="test15-1.base,test15-2.base"/>

  <!-- 1 server -->
  <target name="test15-1.base" depends="init.a3test,compile">
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="15"/>
      <param name="y" value="1"/>
      <param name="a3conf" value="a3/base/a3servers1.xml"/>
      <param name="jvmargs" value="-DEcho=0"/>
    </antcall>
  </target>

  <!-- 2 servers, 1 domain -->
  <target name="test15-2.base" depends="init.a3test,compile">
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="15"/>
      <param name="y" value="2"/>
      <param name="a3conf" value="a3/base/a3servers2.xml"/>
      <param name="jvmargs" value="-DEcho=1"/>
    </antcall>
  </target>

  <!-- 1 domain with http network -->
  <target name="test15.http.base" depends="test15-2a.http.base,test15-2b.http.base,test3-2.http.base"/>
  <target name="test15-2a.http.base" depends="init.a3test,compile">
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="15"/>
      <param name="y" value="http-a"/>
      <param name="a3conf" value="a3/base/a3servers2e1.xml"/>
      <param name="jvmargs" value="-DEcho=1"/>
    </antcall>
  </target>
  <target name="test15-2b.http.base" depends="init.a3test,compile">
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="15"/>
      <param name="y" value="http-b"/>
      <param name="a3conf" value="a3/base/a3servers2e2.xml"/>
      <param name="jvmargs" value="-DEcho=1"/>
    </antcall>
  </target>

  <target name="test16.http.base"  depends="init.a3test,compile">
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="16"/>
      <param name="y" value="a"/>
      <param name="a3conf" value="a3/base/a3servers5.http.xml"/>
      <param name="jvmargs" value="-Dbounce=5000"/>
    </antcall>
  </target>

  <target name="test17.http.base"  depends="init.a3test,compile">
    <antcall target="testx.base" inheritAll="true">
      <param name="x" value="17"/>
      <param name="y" value="a"/>
      <param name="a3conf" value="a3/base/a3servers5.http.xml"/>
      <param name="jvmargs" value="-Dbounce=100000"/>
    </antcall>
  </target>

  <target name="httpinit">
    <antcall target="init.test" inheritAll="true">
      <param name="a3conf" value="a3/base/a3serversX.http.xml"/>
      <param name="a3debug" value="a3debug.cfg"/>
    </antcall>
  </target>

  <target name="httpserver" depends="init,compile,httpinit">
    <java classname="a3.base.httpserver"
          failonerror="no" fork="yes"
          dir="${test.dir}">
      <classpath path="${project.class.path}"/>
      <jvmarg line="-Dcom.sun.management.jmxremote -DMXServer=com.scalagent.jmx.JMXServer"/>
      <arg line="0 ./s0"/>
    </java>
  </target>

  <target name="httpclient" depends="init,compile,httpinit">
    <java classname="a3.base.httpclient"
          failonerror="no" fork="yes"
          dir="${test.dir}">
      <classpath path="${project.class.path}"/>
      <jvmarg line="-Dcom.sun.management.jmxremote -DMXServer=com.scalagent.jmx.JMXServer"/>
      <arg line="0 ./s0"/>
    </java>
  </target>

  <target name="test.init">
    <antcall target="init.test" inheritAll="true">
      <param name="a3conf" value="a3/test/a3servers1.xml"/>
      <param name="a3debug" value="a3debug.cfg"/>
    </antcall>
  </target>

  <target name="test.receiver" depends="init,compile,test.init">
    <java classname="a3.test.Receiver"
          failonerror="no" fork="yes"
          dir="${test.dir}">
      <classpath path="${project.class.path}"/>
      <jvmarg line="-Dcom.sun.management.jmxremote -DMXServer=com.scalagent.jmx.JMXServer"/>
      <arg line="0 ./s0"/>
    </java>
  </target>

  <target name="test.sender1" depends="init">
    <java classname="a3.test.Sender"
          failonerror="no" fork="yes"
          dir="${test.dir}">
      <classpath path="${project.class.path}"/>
      <jvmarg line="-Dcom.sun.management.jmxremote -DMXServer=com.scalagent.jmx.JMXServer"/>
      <arg line="1 ./s1"/>
    </java>
  </target>

  <target name="test.sender2" depends="init">
    <java classname="a3.test.Sender"
          failonerror="no" fork="yes"
          dir="${test.dir}">
      <classpath path="${project.class.path}"/>
      <jvmarg line="-Dcom.sun.management.jmxremote -DMXServer=com.scalagent.jmx.JMXServer"/>
      <arg line="2 ./s2"/>
    </java>
  </target>

  <!--
    - Scalagent middleware recovery tests
    -->
  <target name="tests.a3recovery">
    <ant dir="." antfile="build.xml" target="test1.recovery"/>
    <ant dir="." antfile="build.xml" target="test2.recovery"/>
    <ant dir="." antfile="build.xml" target="test3.recovery"/>
    <ant dir="." antfile="build.xml" target="test4.recovery"/>
    <ant dir="." antfile="build.xml" target="test5.recovery"/>
    <ant dir="." antfile="build.xml" target="test6.recovery"/>
    <ant dir="." antfile="build.xml" target="test7.recovery"/>
    <ant dir="." antfile="build.xml" target="test8.recovery"/>
    <ant dir="." antfile="build.xml" target="test9.recovery"/>
    <ant dir="." antfile="build.xml" target="test10.recovery"/>
  </target>

  <target name="tests.http.recovery">
    <ant dir="." antfile="build.xml" target="test1.http.recovery"/>
    <ant dir="." antfile="build.xml" target="test2-1.http.recovery"/>
    <ant dir="." antfile="build.xml" target="test2-2.http.recovery"/>
    <ant dir="." antfile="build.xml" target="test3.http.recovery"/>
    <ant dir="." antfile="build.xml" target="test4.http.recovery"/>
    <ant dir="." antfile="build.xml" target="test5.http.recovery"/>
    <ant dir="." antfile="build.xml" target="test8-1.http.recovery"/>
    <ant dir="." antfile="build.xml" target="test8-2.http.recovery"/>
    <ant dir="." antfile="build.xml" target="test9.http.recovery"/>
    <ant dir="." antfile="build.xml" target="test10.http.recovery"/>
  </target>

  <!--
    - Test the recovery capability (using ping-pong)
    -->
  <target name="test1.recovery" depends="test1-3.recovery"/>

  <target name="prop1.recovery" depends="prop1.recovery.windows,prop1.recovery.unix"/>

  <target name="prop1.recovery.windows" if="windows">
    <property name="jvmargs" value="-Dbounce=50000 -Dtimeout=1200000"/>
  </target>

  <target name="prop1.recovery.unix" if="unix">
    <property name="jvmargs" value="-Dbounce=50000 -Dtimeout=1200000"/>
  </target>

  <!--
    - recovery test launcher
    -->
  <target name="testx.recovery">
    <antcall target="testx" inheritAll="true">
      <param name="package" value="a3.recovery"/>
    </antcall>
  </target>

  <!-- 1 domain -->
  <target name="test1-3.recovery" depends="init.a3test,compile,prop1.recovery">
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="1"/>
      <param name="y" value="3"/>
      <param name="a3conf" value="a3/recovery/a3servers1.xml"/>
    </antcall>
  </target>

  <!-- 1 domain, HttpNetwork -->
  <target name="test1.http.recovery" depends="init.a3test,compile,prop1.recovery">
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="1"/>
      <param name="y" value="http-a"/>
      <param name="a3conf" value="a3/recovery/a3servers1.http.1.xml"/>
    </antcall>
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="1"/>
      <param name="y" value="http-b"/>
      <param name="a3conf" value="a3/recovery/a3servers1.http.2.xml"/>
    </antcall>
  </target>

  <target name="test2.recovery" depends="test2-1.recovery"/>

  <target name="prop2.recovery" depends="prop2.recovery.windows,prop2.recovery.unix"/>

  <target name="prop2.recovery.windows" if="windows">
    <property name="jvmargs" value="-Dbounce=2500 -Dtimeout=360000"/>
  </target>

  <target name="prop2.recovery.unix" if="unix">
    <property name="jvmargs" value="-Dbounce=50000 -Dtimeout=1200000"/>
  </target>

  <!-- 2 domains -->
  <target name="test2-1.recovery" depends="init.a3test,compile,prop2.recovery">
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="2"/>
      <param name="y" value="1"/>
      <param name="a3conf" value="a3/recovery/a3servers2.xml"/>
    </antcall>
  </target>

  <!-- 3 http servers, 1! domain -->
  <target name="test2-1.http.recovery" depends="init.a3test,compile,prop2.recovery">
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="2"/>
      <param name="y" value="1.http"/>
      <param name="a3conf" value="a3/recovery/a3servers2.http.1.xml"/>
    </antcall>
  </target>

  <!-- 3 http servers, 2 domains -->
  <target name="test2-2.http.recovery" depends="init.a3test,compile,prop2.recovery">
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="2"/>
      <param name="y" value="2a.http"/>
      <param name="a3conf" value="a3/recovery/a3servers2.http.1.xml"/>
    </antcall>
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="2"/>
      <param name="y" value="2b.http"/>
      <param name="a3conf" value="a3/recovery/a3servers2.http.1.xml"/>
    </antcall>
  </target>

  <!--
    - Test various mechanism in case of failure/recovery.
    -->

  <!-- Test the agent deletion -->
  <target name="test3.recovery" depends="init.a3test,compile">
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="3"/>
      <param name="y" value="1"/>
      <param name="a3conf" value="a3/recovery/a3servers1.xml"/>
      <param name="jvmargs" value=""/>
    </antcall>
  </target>

  <target name="test3.http.recovery" depends="init.a3test,compile">
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="3"/>
      <param name="y" value="1.http-a"/>
      <param name="a3conf" value="a3/recovery/a3servers1.http.1.xml"/>
      <param name="jvmargs" value=""/>
    </antcall>
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="3"/>
      <param name="y" value="1.http-b"/>
      <param name="a3conf" value="a3/recovery/a3servers1.http.2.xml"/>
      <param name="jvmargs" value=""/>
    </antcall>
  </target>

  <!--
    - Test the connection to a server launched after a failure.
    -->
  <target name="test4.recovery" depends="init.a3test,compile">
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="4"/>
      <param name="y" value="1"/>
      <param name="a3conf" value="a3/recovery/a3servers1.xml"/>
      <param name="jvmargs" value="-Dpause=15000"/>
    </antcall>
  </target>

  <target name="test4.http.recovery" depends="init.a3test,compile">
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="4"/>
      <param name="y" value="1.http-a"/>
      <param name="a3conf" value="a3/recovery/a3servers1.http.1.xml"/>
      <param name="jvmargs" value="-Dpause=15000"/>
    </antcall>
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="4"/>
      <param name="y" value="1.http-b"/>
      <param name="a3conf" value="a3/recovery/a3servers1.http.2.xml"/>
      <param name="jvmargs" value="-Dpause=15000"/>
    </antcall>
  </target>

  <!--
    - Test the connection to a server launched after a big time.
    -->
  <target name="test5.recovery" depends="init.a3test,compile">
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="5"/>
      <param name="y" value="1"/>
      <param name="a3conf" value="a3/recovery/a3servers1.xml"/>
      <param name="jvmargs" value="-Dpause=20000"/>
    </antcall>
  </target>

  <target name="test5.http.recovery" depends="init.a3test,compile">
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="5"/>
      <param name="y" value="1.http-a"/>
      <param name="a3conf" value="a3/recovery/a3servers1.http.1.xml"/>
      <param name="jvmargs" value="-Dpause=20000"/>
    </antcall>
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="5"/>
      <param name="y" value="1.http-b"/>
      <param name="a3conf" value="a3/recovery/a3servers1.http.2.xml"/>
      <param name="jvmargs" value="-Dpause=20000"/>
    </antcall>
  </target>

  <!--
    - Test the recovery capability (using ping-pong)
    -->
  <target name="test6.recovery" depends="test6-1.recovery"/>

  <target name="test6-1.recovery" depends="init.a3test,compile">
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="6"/>
      <param name="y" value="1"/>
      <param name="a3conf" value="a3/recovery/a3servers1.xml"/>
      <param name="jvmargs" value=""/>
    </antcall>
  </target>

  <!--
    - Test the connection to a server launched after a failure
    - without persistancy.
    -->
  <target name="test7.recovery" depends="init.a3test,compile">
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="7"/>
      <param name="y" value="1"/>
      <param name="transaction" value="fr.dyade.aaa.util.NullTransaction"/>
      <param name="a3conf" value="a3/recovery/a3servers1.xml"/>
      <param name="jvmargs" value="-Dpause=15000"/>
    </antcall>
  </target>

  <target name="test7-2a.recovery" depends="init.a3test,compile">
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="7"/>
      <param name="y" value="2a"/>
      <param name="transaction" value="fr.dyade.aaa.util.NullTransaction"/>
      <param name="a3conf" value="a3/recovery/a3servers1e1.xml"/>
      <param name="jvmargs" value="-Dpause=15000"/>
    </antcall>
  </target>

  <target name="test7-2b.recovery" depends="init.a3test,compile">
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="7"/>
      <param name="y" value="2b"/>
      <param name="transaction" value="fr.dyade.aaa.util.NullTransaction"/>
      <param name="a3conf" value="a3/recovery/a3servers1e2.xml"/>
      <param name="jvmargs" value="-Dpause=15000"/>
    </antcall>
  </target>

  <!--
    - Test the connection to a double Ping/Pong in case of failure.
    -->
  <target name="test8.recovery" depends="test8-1.recovery,test8-2.recovery"/>

  <!-- 1 domain -->
  <target name="test8-1.recovery" depends="init.a3test,compile,prop1.recovery">
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="8"/>
      <param name="y" value="1"/>
      <param name="a3conf" value="a3/recovery/a3servers1.xml"/>
    </antcall>
  </target>

  <target name="test8-2.recovery" depends="init.a3test,compile,prop1.recovery">
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="8"/>
      <param name="y" value="2"/>
      <param name="a3conf" value="a3/recovery/a3servers3.xml"/>
    </antcall>
  </target>

  <!-- 3 servers HttpNetwork, 1! domain -->
  <target name="test8-1.http.recovery" depends="init.a3test,compile,prop1.recovery">
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="8"/>
      <param name="y" value="1a.http"/>
      <param name="a3conf" value="a3/recovery/a3servers2.http.xml"/>
    </antcall>
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="8"/>
      <param name="y" value="1b.http"/>
      <param name="a3conf" value="a3/recovery/a3servers3.http.xml"/>
    </antcall>
  </target>

  <!-- 3 servers HttpNetwork, 2 domains -->
   <target name="test8-2.http.recovery" depends="init.a3test,compile,prop1.recovery">
   <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="8"/>
      <param name="y" value="2a.http"/>
      <param name="a3conf" value="a3/recovery/a3servers2.http.1.xml"/>
    </antcall>
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="8"/>
      <param name="y" value="2b.http"/>
      <param name="a3conf" value="a3/recovery/a3servers2.http.2.xml"/>
    </antcall>
  </target>

  <!--
    - Test the detachable property of Notification in case of failure.
    -->
  <target name="test9.recovery" depends="init.a3test,compile,prop1.recovery">
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="9"/>
      <param name="y" value="1"/>
      <param name="a3conf" value="a3/recovery/a3servers1.xml"/>
    </antcall>
  </target>

  <!-- 1 domain, HttpNetwork -->
  <target name="test9.http.recovery" depends="init.a3test,compile,prop1.recovery">
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="9"/>
      <param name="y" value="3a"/>
      <param name="a3conf" value="a3/recovery/a3servers1.http.1.xml"/>
    </antcall>
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="9"/>
      <param name="y" value="3b"/>
      <param name="a3conf" value="a3/recovery/a3servers1.http.2.xml"/>
    </antcall>
  </target>

  <!--
    - Test the expiration property of Notification in case of failure.
    -->
  <target name="test10.recovery" depends="init.a3test,compile,prop1.recovery">
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="10"/>
      <param name="y" value="1"/>
      <param name="a3conf" value="a3/recovery/a3servers1.xml"/>
    </antcall>
  </target>

  <!-- 1 domain, HttpNetwork -->
  <target name="test10.http.recovery" depends="test10a.http.recovery,test10b.http.recovery"/>
  <target name="test10a.http.recovery" depends="init.a3test,compile,prop1.recovery">
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="10"/>
      <param name="y" value="1a"/>
      <param name="a3conf" value="a3/recovery/a3servers1.http.1.xml"/>
    </antcall>
  </target>
  <target name="test10b.http.recovery" depends="init.a3test,compile,prop1.recovery">
    <antcall target="testx.recovery" inheritAll="true">
      <param name="x" value="10"/>
      <param name="y" value="1b"/>
      <param name="a3conf" value="a3/recovery/a3servers1.http.2.xml"/>
    </antcall>
  </target>

  <!--
    - Simple performance tests
    -->
  <target name="tests.a3perf">
    <ant dir="." antfile="build.xml" target="test1.perf"/>
    <ant dir="." antfile="build.xml" target="test2.perf"/>
    <ant dir="." antfile="build.xml" target="test5.perf"/>
  </target>

  <!--
    - perf test launcher
    -->
  <target name="testx.perf">
    <antcall target="testx" inheritAll="true">
      <param name="package" value="a3.perf"/>
    </antcall>
  </target>

  <!-- A simple Agent test [Ping/Pong] -->
  <target name="test1.perf" depends="test1-1.perf,test1-2.perf,test1-3.perf"/>

  <!-- Centralized -->
  <target name="test1-1.perf" depends="init.a3test,compile">
    <antcall target="testx.perf" inheritAll="true">
      <param name="x" value="1"/>
      <param name="y" value="1"/>
      <param name="a3conf" value="a3/perf/a3servers0.xml"/>
      <param name="jvmargs" value="-DPing=0 -DPong=0 -Dbounce=499"/>
    </antcall>
  </target>

  <!-- Distributed -->
  <target name="test1-2.perf" depends="init.a3test,compile">
    <antcall target="testx.perf" inheritAll="true">
      <param name="x" value="1"/>
      <param name="y" value="2"/>
      <param name="a3conf" value="a3/perf/a3servers1.xml"/>
      <param name="jvmargs" value="-DPing=0 -DPong=1 -Dbounce=99"/>
    </antcall>
  </target>

  <!-- Centralized + NullTransaction -->
  <target name="test1-3.perf" depends="init.a3test,compile">
    <antcall target="testx.perf" inheritAll="true">
      <param name="x" value="1"/>
      <param name="y" value="3"/>
      <param name="transaction" value="fr.dyade.aaa.util.NullTransaction"/>
      <param name="a3conf" value="a3/perf/a3servers0.xml"/>
      <param name="jvmargs" value="-DPing=0 -DPong=0 -Dbounce=24999"/>
    </antcall>
  </target>

  <!-- Another simple Agent test [Counter] -->
  <target name="test2.perf" depends="test2-1.perf,test2-2.perf,test2-3.perf"/>

  <!-- Centralized -->
  <target name="test2-1.perf" depends="init.a3test,compile">
    <antcall target="testx.perf" inheritAll="true">
      <param name="x" value="2"/>
      <param name="y" value="1"/>
      <param name="a3conf" value="a3/perf/a3servers0.xml"/>
      <param name="jvmargs" value="-DRecv=0 -DSend=0 -Dbounce=99"/>
    </antcall>
  </target>

  <!-- Distributed -->
  <target name="test2-2.perf" depends="init.a3test,compile">
    <antcall target="testx.perf" inheritAll="true">
      <param name="x" value="2"/>
      <param name="y" value="2"/>
      <param name="a3conf" value="a3/perf/a3servers1.xml"/>
      <param name="jvmargs" value="-DRecv=1 -DSend=0 -Dbounce=99"/>
    </antcall>
  </target>

  <!-- Centralized + NullTransaction -->
  <target name="test2-3.perf" depends="init.a3test,compile">
    <antcall target="testx.perf" inheritAll="true">
      <param name="x" value="2"/>
      <param name="y" value="3"/>
      <param name="transaction" value="fr.dyade.aaa.util.NullTransaction"/>
      <param name="a3conf" value="a3/perf/a3servers0.xml"/>
      <param name="jvmargs" value="-DRecv=0 -DSend=0 -Dbounce=99"/>
    </antcall>
  </target>

  <!-- Another Agent test [Tree] -->
  <target name="test5.perf" depends="test5-1.perf,test5-2.perf"/>

  <target name="test5-1.optit" depends="init.a3test,compile">
    <antcall target="init.test" inheritAll="true">
      <param name="a3conf" value="a3/perf/a3servers0.xml"/>
    </antcall>
  </target>

  <!-- Centralized -->
  <target name="test5-1.perf" depends="init.a3test,compile">
    <antcall target="testx.perf" inheritAll="true">
      <param name="x" value="5"/>
      <param name="y" value="1"/>
      <param name="a3conf" value="a3/perf/a3servers0.xml"/>
      <param name="jvmargs" value=""/>
    </antcall>
  </target>

  <!-- Distributed -->
  <target name="test5-2.perf" depends="init.a3test,compile">
    <antcall target="testx.perf" inheritAll="true">
      <param name="x" value="5"/>
      <param name="y" value="2"/>
      <param name="a3conf" value="a3/perf/a3servers1.xml"/>
      <param name="jvmargs" value="-DNbNode=2"/>
    </antcall>
  </target>

<!--</project>-->
