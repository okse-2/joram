<?xml version="1.0"?>

<project default="init" basedir=".">

  <!-- Initializes the environment paths and properties -->
  <target name="init">
    <!-- Initializes the directory structure properties -->
    <property name="lib.dir" location="ship/lib"/>
    <property name="tmp.dir" location="tmp"/>
  </target>

<!-- ***************************************************************** -->
<!-- *                  Update Joram in JOnAS                        * -->
<!-- ***************************************************************** -->
  <target name="jonas.env" depends="init">
    <property environment="env"/>
    <condition property="jonas.root" value="${env.JONAS_ROOT}">
      <and>
        <isset property="env.JONAS_ROOT"/>
      </and>
    </condition>
    <fail message="You have to define the JONAS_ROOT environnement variable or the jonas.root property"
          unless="jonas.root"/>
    <condition property="jonas.base" value="${env.JONAS_BASE}">
      <and>
        <isset property="env.JONAS_BASE"/>
      </and>
    </condition>
    <echo message="JONAS_ROOT=${jonas.root}"/>
    <echo message="JONAS_BASE=${jonas.base}"/>
    <available file="${jonas.root}/lib/commons/jonas/joram" type="dir"
               property="jonas.root.lib.present"/>
    <available file="${jonas.base}/lib/commons/jonas/joram" type="dir"
               property="jonas.base.lib.present"/>
    <available file="${jonas.root}/rars/joram_for_jonas_ra.rar" 
               property="jonas.root.rars.present"/>
    <available file="${jonas.base}/rars/joram_for_jonas_ra.rar" 
               property="jonas.base.rars.present"/>
    <available file="${jonas.root}/rars/autoload/joram_for_jonas_ra.rar" 
               property="jonas.root.rars.auto.present"/>
    <available file="${jonas.base}/rars/autoload/joram_for_jonas_ra.rar" 
               property="jonas.base.rars.auto.present"/>
    <available file="${jonas.root}/lib/client.jar" 
               property="jonas.root.clt.present"/>
    <available file="${jonas.base}/lib/client.jar" 
               property="jonas.base.clt.present"/>
  </target>

  <target name="putJoramInJonas"
          depends="jonas.env"
          description="--> Install Joram into JOnAS (updating librairies)">
    <antcall target="putJarInJonasRoot" inheritAll="true"/>
    <antcall target="putJarInJonasBase" inheritAll="true"/>
    <antcall target="putRarInJonasRoot" inheritAll="true"/>
    <antcall target="putRarInJonasBase" inheritAll="true"/>
    <antcall target="putRarInJonasRootAuto" inheritAll="true"/>
    <antcall target="putRarInJonasBaseAuto" inheritAll="true"/>
    <antcall target="updateClientInJonasRoot" inheritAll="true"/>
    <antcall target="updateClientInJonasBase" inheritAll="true"/>
  </target>

  <target name="putJarInJonasRoot" if="jonas.root.lib.present">
    <copy toDir="${jonas.root}/lib/commons/jonas/joram" overwrite="true">
      <fileset dir="${lib.dir}">
        <include name="joram-client.jar"/>
        <include name="joram-connector.jar"/>
        <include name="joram-mom.jar"/>
        <include name="joram-shared.jar"/>
      </fileset>
    </copy>
  </target>

  <target name="putJarInJonasBase" if="jonas.base.lib.present">
    <copy toDir="${jonas.base}/lib/commons/jonas/joram" overwrite="true">
      <fileset dir="${lib.dir}">
        <include name="joram-client.jar"/>
        <include name="joram-connector.jar"/>
        <include name="joram-mom.jar"/>
        <include name="joram-shared.jar"/>
      </fileset>
    </copy>
  </target>

  <target name="putRarInJonasRoot" if="jonas.root.rars.present">
    <copy file="${lib.dir}/joram_for_jonas_ra.rar" toDir="${jonas.root}/rars" overwrite="true"/>
  </target>

  <target name="putRarInJonasBase" if="jonas.base.rars.present">
    <copy file="${lib.dir}/joram_for_jonas_ra.rar" toDir="${jonas.base}/rars" overwrite="true"/>
  </target>

  <target name="putRarInJonasRootAuto" if="jonas.root.rars.auto.present">
    <copy file="${lib.dir}/joram_for_jonas_ra.rar" toDir="${jonas.root}/rars/autoload" overwrite="true"/>
  </target>

  <target name="putRarInJonasBaseAuto" if="jonas.base.rars.auto.present">
    <copy file="${lib.dir}/joram_for_jonas_ra.rar" toDir="${jonas.base}/rars/autoload" overwrite="true"/>
  </target>

  <target name="updateClientInJonasRoot" if="jonas.root.clt.present">
    <delete dir="${tmp.dir}"/>
    <mkdir dir="${tmp.dir}"/>
    <unzip src="${lib.dir}/joram-client.jar" dest="${tmp.dir}"/>
    <unzip src="${lib.dir}/joram-shared.jar" dest="${tmp.dir}"/>
    <unzip src="${lib.dir}/joram-connector.jar" dest="${tmp.dir}"/>
    <jar destfile="${jonas.root}/lib/client.jar" 
         update="true"
         basedir="${tmp.dir}">
    </jar>
    <delete dir="${tmp.dir}"/>
  </target>
  <target name="updateClientInJonasBase" if="jonas.base.clt.present">
   <delete dir="${tmp.dir}"/>
    <mkdir dir="${tmp.dir}"/>
    <unzip src="${lib.dir}/joram-client.jar" dest="${tmp.dir}"/>
    <unzip src="${lib.dir}/joram-shared.jar" dest="${tmp.dir}"/>
    <unzip src="${lib.dir}/joram-connector.jar" dest="${tmp.dir}"/>
    <jar destfile="${jonas.base}/lib/client.jar" 
         update="true"
         basedir="${tmp.dir}">
    </jar>
    <delete dir="${tmp.dir}"/>
  </target>

</project>
