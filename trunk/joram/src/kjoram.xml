<?xml version="1.0" standalone="yes"?>

<project default="ship.kjoram" basedir=".">
  <!-- Initializes properties -->
  <target name="init">
    <!-- Creates the time stamp -->
    <tstamp/>
    <!-- Initializes the environment properties, uses ${env.name} -->
    <property environment="env"/>
  
    <!-- Gets the user defined properties from file -->
    <property file="build.properties"/>

    <!-- Initializes the directory structure properties -->
    <property name="src.dir" location="."/>
    <property name="obj.dir" location="../classes"/>
    <property name="lib.dir" location="../lib"/>
    <property name="licenses.dir" location="../licenses"/>
    <property name="releases.dir" location="../releases"/>

    <!-- Base classpath needed for execution -->
    <path id="base.class.path">
      <pathelement path="${java.class.path}/"/>
      <fileset dir="${lib.dir}">
        <include name="kxml.jar"/>
        <include name="midpapi.jar"/>
      </fileset>
    </path>

    <!-- Project classpath needed for compilation -->
    <path id="project.class.path">
      <path refid="base.class.path"/>
      <pathelement path="${obj.dir}"/>
      <pathelement path="${additional.path}"/>
    </path>
  </target>

  <!-- Cleans all generated files -->
  <target name="clean" depends="init"
      description="--> Cleans all generated files">
    <delete dir="${obj.dir}"/>
    <delete dir="${doc.dir}"/>
    <!-- Deletes generated jar file -->
    <delete file="${lib.dir}/kjoram.jar" />
  </target>

  <!-- Prepares compilation phase -->
  <target name="prepare" depends="init">
    <!-- Creates the directory structure -->
    <mkdir dir="${obj.dir}"/>
  </target>

  <!-- Compilation phase -->
  <target name="compile" depends="prepare"
      description="--> Compiles kJoram sources.">
    <javac target="1.1"
           bootclasspath="${lib.dir}/midpapi.zip"
           srcdir="${src.dir}:${obj.dir}"
           destdir="${obj.dir}"
           debug="on"
           deprecation="${deprecation}"
           optimize="false"
           nowarn="${nowarn}"
           verbose="${verbose}">

      <classpath refid="project.class.path"/>

      <include name="com/**/*.java"/>
      <exclude name="com/**/jmx/*.java"/>
 
    </javac>
  </target>

  <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
     - kJoram specific build target
     - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
  <!-- JARS BUILDING -->
  <target name="ship.kjoram" depends="init,compile"
      description="--> Builds kJoram client jar.">
    <jar jarfile="${lib.dir}/kjoram.jar">
      <fileset dir="${obj.dir}">
        <include name="com/**/*.class"/>
      </fileset>
    </jar>
  </target>

  <!-- RELEASES -->
  <target name="releases" depends="release.src, release.jar"
    if="version"/>

  <target name="release.jar" depends="clean,ship.kjoram" if="version">
    <copy todir="../kjoram-${version}" includeEmptyDirs="no">
      <fileset dir="..">
	<include name="lib/kjoram.jar" />
	<include name="lib/kxml.jar" />
	<include name="lib/midpapi.jar" />
	<include name="licenses/LGPL_HEADER.TXT" />
	<include name="samples/src/kjoram/**" />
      </fileset>
    </copy>
    <tar tarfile="kjoram-${version}.tar"
      longfile="gnu"
      basedir=".."
      includes="kjoram-${version}/**" />
    <gzip zipfile="kjoram-${version}.tgz" src="kjoram-${version}.tar" />
    <delete file="kjoram-${version}.tar" /> 
    <delete dir="../kjoram-${version}" /> 
    <mkdir dir="${releases.dir}" />
    <move file="kjoram-${version}.tgz" todir="${releases.dir}" />
  </target>

  <target name="release.src" depends="clean" if="version">
    <copy todir="../kjoram-${version}-src" includeEmptyDirs="no">
      <fileset dir="..">
	<include name="lib/kxml.jar" />
	<include name="lib/midpapi.jar" />
	<include name="licenses/LGPL_HEADER.TXT" />
	<include name="samples/src/kjoram/**" />
        <include name="src/com/**/*.java" />
        <include name="src/build.properties" />
        <include name="src/kjoram.xml" />
      </fileset>
    </copy>
    <move file="../kjoram-${version}-src/src/kjoram.xml"
          tofile="../kjoram-${version}-src/src/build.xml" />
    <tar tarfile="kjoram-${version}-src.tar"
      longfile="gnu"
      basedir=".."
      includes="kjoram-${version}-src/**" />
    <gzip zipfile="kjoram-${version}-src.tgz" src="kjoram-${version}-src.tar" />
    <delete file="kjoram-${version}-src.tar" /> 
    <delete dir="../kjoram-${version}-src" /> 
    <mkdir dir="${releases.dir}" />
    <move file="kjoram-${version}-src.tgz" todir="${releases.dir}" />
  </target>
</project>
