<?xml version="1.0"?>

<!DOCTYPE project [
    <!ENTITY common SYSTEM "file:./common.xml">
]>

<project default="ship" basedir=".">
  <!-- Includes generic stuff -->
  &common;

  <!-- Initializes properties -->
  <target name="init.joram" depends="init">
    <property name="releases.dir" location="../releases"/>
    <property name="samples.dir" location="../samples"/>

    <!-- Defines specific fileset to compile -->
    <patternset id="specific.compile.sources" >
      <include name="fr/dyade/aaa/agent/AgentServer.java"/>
      <include name="fr/dyade/aaa/agent/Engine.java"/>
      <include name="fr/dyade/aaa/agent/TransactionEngine.java"/>
      <include name="fr/dyade/aaa/agent/GCTransactionEngine.java"/>
      <include name="fr/dyade/aaa/agent/SimpleNetwork.java"/>
      <include name="fr/dyade/aaa/agent/HttpNetwork.java"/>
      <include name="fr/dyade/aaa/agent/SCServer.java"/>
      <include name="fr/dyade/aaa/agent/SCAdminBase.java"/>
      <include name="fr/dyade/aaa/agent/AgentAdmin.java"/>
      <include name="fr/dyade/aaa/agent/HttpDebug.java"/>
      <include name="fr/dyade/aaa/agent/conf/A3CMLSaxWrapper.java"/>
      <include name="fr/dyade/aaa/agent/conf/A3CMLKXmlWrapper.java"/>
      <include name="fr/dyade/aaa/agent/management/*.java"/>
      <!-- include name="com/scalagent/jmx/*.java"/ -->
      <include name="fr/dyade/aaa/admin/**/*.java"/>
      <include name="fr/dyade/aaa/jndi2/**/*.java"/>
      <include name="fr/dyade/aaa/util/NullTransaction.java"/>
      <include name="fr/dyade/aaa/util/ATransaction.java"/>
      <include name="fr/dyade/aaa/util/AFastTransaction.java"/>
      <include name="fr/dyade/aaa/util/NTransaction.java"/>
      <include name="org/objectweb/joram/**/*.java"/>
    </patternset>

    <!-- Specific classpath needed for compilation -->
    <path id="specific.class.path">
      <path refid="project.class.path"/>
    </path>
  </target>

  <!-- Builds all needed jars -->
  <target name="build.joram" depends="init.joram,compile"
      description="--> Builds Joram server and client jars.">
    <mkdir dir="${build.dir}/META-INF"/>
    <jar jarfile="${build.dir}/joram-shared.jar">
      <fileset dir="${obj.dir}">
        <include name="fr/dyade/aaa/jndi2/msg/*.class"/>
        <include name="fr/dyade/aaa/jndi2/soap/SoapObjectHelper.class"/>
        <include name="fr/dyade/aaa/jndi2/soap/SoapObjectItf.class"/>
        <include name="fr/dyade/aaa/util/*.class"/>
        <include name="org/objectweb/joram/shared/admin/*.class"/>
        <include name="org/objectweb/joram/shared/client/*.class"/>
        <include name="org/objectweb/joram/shared/excepts/*.class"/>
        <include name="org/objectweb/joram/shared/messages/*.class"/>
        <include name="org/objectweb/joram/shared/selectors/*.class"/>
      </fileset>
    </jar>
    <jar jarfile="${build.dir}/joram-mom.jar">
      <fileset dir="${obj.dir}">
        <include name="fr/dyade/aaa/admin/*.class"/>
        <include name="fr/dyade/aaa/admin/cmd/*.class"/>
        <include name="fr/dyade/aaa/admin/script/*.class"/>
        <include name="fr/dyade/aaa/agent/*.class"/>
        <include name="fr/dyade/aaa/agent/conf/*.class"/>
        <include name="fr/dyade/aaa/agent/management/*.class"/>
        <include name="fr/dyade/aaa/jndi2/distributed/*.class"/>
        <include name="fr/dyade/aaa/jndi2/impl/*.class"/>
        <include name="fr/dyade/aaa/jndi2/server/*.class"/>
        <include name="fr/dyade/aaa/jndi2/soap/JndiSoapService.class"/>
        <include name="org/objectweb/joram/mom/*.class"/>
        <include name="org/objectweb/joram/mom/dest/*.class"/>
        <include name="org/objectweb/joram/mom/notifications/*.class"/>
        <include name="org/objectweb/joram/mom/proxies/*.class"/>
        <include name="org/objectweb/joram/mom/proxies/soap/*.class"/>
        <include name="org/objectweb/joram/mom/proxies/tcp/*.class"/>
        <include name="org/objectweb/joram/mom/util/*.class"/>
      </fileset>
    </jar>
    <jar jarfile="${build.dir}/joram-client.jar">
      <fileset dir="${obj.dir}">
        <include name="fr/dyade/aaa/jndi2/client/*.class"/>
        <include name="fr/dyade/aaa/jndi2/scn/*.class"/>
        <include name="fr/dyade/aaa/jndi2/soap/SoapExt_*.class"/>
        <include name="org/objectweb/joram/client/jms/*.class"/>
        <include name="org/objectweb/joram/client/jms/admin/*.class"/>
        <include name="org/objectweb/joram/client/jms/local/*.class"/>
        <include name="org/objectweb/joram/client/jms/soap/*.class"/>
        <include name="org/objectweb/joram/client/jms/tcp/*.class"/>
      </fileset>
    </jar>
    <jar jarfile="${build.dir}/joram-connector.jar">
      <fileset dir="${obj.dir}">
        <include name="org/objectweb/joram/client/connector/*.class"/>
      </fileset>
    </jar>
    <jar jarfile="${build.dir}/joram-gui.jar">
      <fileset dir="${obj.dir}">
        <include name="org/objectweb/joram/client/tools/admin/*.class"/>
      </fileset>
      <fileset dir="${src.dir}">
        <include name="org/objectweb/joram/client/tools/admin/icons/*.png"/>
      </fileset>
    </jar>
  </target>

  <!-- Ships a JORAM distribution -->
  <target name="ship.joram" depends="ship"/>

  <target name="ship" depends="build.joram,javadoc"
    description="--> Creates a Joram shipment.">
    <mkdir dir="${ship.dir}"/>
    <mkdir dir="${ship.dir}/lib"/>
    <copy file="${lib.dir}/activation.jar" todir="${ship.dir}/lib"/>
    <copy file="${lib.dir}/jakarta-regexp-1.2.jar" todir="${ship.dir}/lib"/>
    <copy file="${lib.dir}/JCup.jar" todir="${ship.dir}/lib"/>
    <copy file="${lib.dir}/jms.jar" todir="${ship.dir}/lib"/>
    <copy file="${lib.dir}/jndi.jar" todir="${ship.dir}/lib"/>
    <copy file="${lib.dir}/jta.jar" todir="${ship.dir}/lib"/>
    <copy file="${lib.dir}/mail.jar" todir="${ship.dir}/lib"/>
    <copy file="${lib.dir}/ow_monolog.jar" todir="${ship.dir}/lib"/>
    <copy file="${lib.dir}/soap.jar" todir="${ship.dir}/lib"/>
    <copy file="${lib.dir}/xerces.jar" todir="${ship.dir}/lib"/>
    <!-- copy file="${lib.dir}/jmxri.jar" todir="${ship.dir}/lib"/ -->
    <!-- copy file="${lib.dir}/jmxtools.jar" todir="${ship.dir}/lib"/ -->
    <copy file="${build.dir}/joram-shared.jar" todir="${ship.dir}/lib"/>
    <copy file="${build.dir}/joram-mom.jar" todir="${ship.dir}/lib"/>
    <copy file="${build.dir}/joram-client.jar" todir="${ship.dir}/lib"/>
    <copy file="${build.dir}/joram-gui.jar" todir="${ship.dir}/lib"/>
    <copy file="${build.dir}/joram-connector.jar" todir="${ship.dir}/lib"/>
    <mkdir dir="${ship.dir}/licences"/>
    <copy todir="${ship.dir}/licences" flatten="yes">
      <fileset dir="${licenses.dir}">
        <include name="APACHE_LICENSE.TXT"/>
        <include name="CUP_LICENSE.TXT"/>
        <include name="LGPL_HEADER.TXT"/>
      </fileset>
    </copy>
    <mkdir dir="${ship.dir}/samples"/>
    <copy todir="${ship.dir}/samples">
      <fileset dir="${samples.dir}">
        <include name="bin/*"/>
        <include name="config/*"/>
        <include name="src/joram/**"/>
      </fileset>
    </copy>
    <mkdir dir="${ship.dir}/apidoc"/>
    <copy todir="${ship.dir}/apidoc">
      <fileset dir="${doc.dir}">
        <include name="**"/>
      </fileset>
    </copy>

  </target>

  <!-- Ships a JORAM JCA 1.5 adapter -->
  <target name="ship.adapter" depends="build.joram"
          description="--> Ships a JORAM JCA adapter">
    <copy file="${src.dir}/org/objectweb/joram/client/connector/ra.xml"
          tofile="${build.dir}/META-INF/ra.xml"/>
    <jar jarfile="${ship.dir}/lib/joram.rar">
      <fileset dir="${build.dir}">
        <include name="joram-client.jar"/>
        <include name="joram-connector.jar"/>
        <include name="joram-mom.jar"/>
        <include name="joram-shared.jar"/>
        <include name="META-INF/ra.xml"/>
      </fileset>
      <fileset dir="${lib.dir}">
        <include name="jakarta-regexp-1.2.jar"/>
        <include name="JCup.jar"/>
        <include name="ow_monolog.jar"/>
        <include name="xerces.jar"/>
      </fileset>
    </jar>
    <delete file="${build.dir}/META-INF/ra.xml"/>
  </target>

  <!-- Ships a JORAM JCA 1.5 adapter for non collocated use -->
  <target name="ship.remoteadapter" depends="build.joram"
          description="--> Ships a JORAM JCA adapter for non collocated use">
    <copy file="${src.dir}/org/objectweb/joram/client/connector/ra-remote.xml"
          tofile="${build.dir}/META-INF/ra.xml"/>
    <jar jarfile="${ship.dir}/lib/joram.rar">
      <fileset dir="${build.dir}">
        <include name="joram-shared.jar"/>
        <include name="joram-client.jar"/>
        <include name="joram-connector.jar"/>
        <include name="META-INF/ra.xml"/>
      </fileset>
      <fileset dir="${lib.dir}">
        <include name="JCup.jar"/>
        <include name="ow_monolog.jar"/>
      </fileset>
    </jar>
    <delete file="${build.dir}/META-INF/ra.xml"/>
  </target>

  <!-- Ships a JORAM JCA 1.5 adapter for JOnAS -->
  <target name="ship.jonasadapter" depends="build.joram"
          description="--> Ships a JORAM JCA adapter for JOnAS">
    <copy file="${src.dir}/org/objectweb/joram/client/connector/ra.xml"
          tofile="${build.dir}/META-INF/ra.xml"/>
    <copy file="${src.dir}/org/objectweb/joram/client/connector/jonas-ra.xml"
          tofile="${build.dir}/META-INF/jonas-ra.xml"/>
    <jar jarfile="${ship.dir}/lib/joram_for_jonas_ra.rar">
      <fileset dir="${build.dir}">
        <include name="META-INF/*.xml"/>
      </fileset>
    </jar>
    <delete file="${build.dir}/META-INF/ra.xml"/>
    <delete file="${build.dir}/META-INF/jonas-ra.xml"/>
  </target>

  <!-- JAVADOC --> 
  <target name="javadoc" depends="prepare"
      description="--> Generates the JavaDoc.">
    <javadoc sourcepath="${src.dir}"
             destdir="${doc.dir}"
             classpathref="project.class.path"
             overview="overview.html"
             access="protected"
             version="false"
             author="false"
             use="false"
             windowtitle="Joram(TM) Platform Documentation"
             doctitle="Joram(TM) Platform Documentation"
             bottom="Copyright &#xA9; 2004 Scalagent - All rights reserved">
      <doctitle><![CDATA[<h1>Joram(TM) Documentation</h1>]]></doctitle>
      <package name="fr.dyade.aaa.*"/>
      <package name="org.objectweb.joram.*"/>
    </javadoc>
  </target>

  <!-- RELEASES -->
  <target name="releases" depends="release.src, release.jar"
    if="version"/>

  <target name="release.jar" depends="clean,ship" if="version">
    <copy todir="../joram-${version}" includeEmptyDirs="no">
      <fileset dir="..">
	<exclude name="build.xml" />
	<exclude name="src/**" />
	<exclude name="classes/**" />
	<exclude name="lib/jmxri.jar" />
	<exclude name="lib/jmxtools.jar" />
	<exclude name="lib/kxml.jar" />
	<exclude name="lib/midpapi.jar" />
	<exclude name="releases/**" />
        <exclude name="samples/config/jmxable_a3servers.xml" />
	<exclude name="samples/src/kjoram/**" />
      </fileset>
    </copy>
    <tar tarfile="joram-${version}.tar"
      longfile="gnu"
      basedir=".."
      includes="joram-${version}/**" />
    <gzip zipfile="joram-${version}.tgz" src="joram-${version}.tar" />
    <delete file="joram-${version}.tar" /> 
    <delete dir="../joram-${version}" /> 
    <mkdir dir="${releases.dir}" />
    <move file="joram-${version}.tgz" todir="${releases.dir}" />
  </target>

  <target name="release.src" depends="clean" if="version">
    <copy todir="../joram-${version}-src" includeEmptyDirs="no">
      <fileset dir="..">
	<exclude name="build.xml" />
	<exclude name="src/fr/dyade/aaa/ns/**" />
	<exclude name="classes/**" />
        <exclude name="lib/jmxri.jar" />
	<exclude name="lib/jmxtools.jar" />
	<exclude name="lib/kxml.jar" />
	<exclude name="lib/midpapi.jar" />
	<exclude name="releases/**" />
	<exclude name="samples/config/jmxable_a3servers.xml" />
	<exclude name="samples/src/kjoram/**" />
	<exclude name="src/com/**" />
	<exclude name="src/kjoram.xml" />
      </fileset>
    </copy>
    <move file="../joram-${version}-src/src/joram.xml"
          tofile="../joram-${version}-src/src/build.xml" />
    <tar tarfile="joram-${version}-src.tar"
      longfile="gnu"
      basedir=".."
      includes="joram-${version}-src/**" />
    <gzip zipfile="joram-${version}-src.tgz" src="joram-${version}-src.tar" />
    <delete file="joram-${version}-src.tar" /> 
    <delete dir="../joram-${version}-src" /> 
    <mkdir dir="${releases.dir}" />
    <move file="joram-${version}-src.tgz" todir="${releases.dir}" />
  </target>

  <target name="crlfbin" depends="init.joram">
    <fixcrlf srcdir="${samples.dir}/bin" eol="crlf"
             includes="*.bat"/>
    <fixcrlf srcdir="${samples.dir}/bin" eol="lf"
             includes="*.sh"/>
  </target>
</project>
