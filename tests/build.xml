<?xml version="1.0" standalone="yes"?>

<project default="compile" basedir=".">
  <!-- Initializes properties -->
  <target name="init">
    <!-- Create the time stamp -->
    <tstamp/>
    <!-- Initialize the environment properties, use ${env.name} -->
    <property environment="env"/>
  
    <!-- Get the user defined properties from file -->
    <property file="build.properties"/>

    <!-- Initialize the directory structure properties -->
    <property name="src.dir" location="src"/>
    <property name="obj.dir" location="classes"/>
    <property name="lib.dir" location="lib"/>
    <property name="config.dir" location="config"/>
    <property name="build.dir" location="build"/>
    <property name="jdoc.dir" location="javadoc"/>
    <property name="test.dir" location="run"/>
    <property name="providers.dir" location="providers"/>
    <property name="report.dir" location="report"/>

    <!-- Base classpath needed for execution -->
    <path id="base.class.path">
      <pathelement path="${java.class.path}/"/>
      <fileset dir="${lib.dir}">
	<include name="xalan.jar" />
        <include name="*.jar"/>
      </fileset>
    </path>

    <!-- Project classpath needed for compilation -->
    <path id="project.class.path">
      <path refid="base.class.path"/>
      <pathelement path="${obj.dir}"/>
      <pathelement path="${config.dir}"/>
    </path>
  </target>
  
  <!-- Clean all generated files -->
  <target name="clean" depends="init"
      description="--> Clean all generated files">
    <delete dir="${obj.dir}"/>
    <delete dir="${jdoc.dir}"/>
    <delete dir="${test.dir}"/>
    <delete dir="${report.dir}"/>
    <delete>
      <fileset dir=".">
        <Include name="**/junit*.properties"/>
      </fileset>
    </delete>
  </target>

  <!-- Prepare compilation phase -->
  <target name="prepare" depends="init">
    <!-- Create the directory structure -->
    <mkdir dir="${obj.dir}"/>
    <mkdir dir="${jdoc.dir}"/>
  </target>

  <target name="prepare.providers" depends="init">
    <!-- Project classpath needed for compilation -->
    <path id="project.class.path">
      <path refid="base.class.path"/>
      <pathelement path="${obj.dir}"/>
      <pathelement path="${config.dir}"/>
      <fileset dir="${providers.dir}">
        <include name="**/*"/>
      </fileset>
    </path>
  </target>

  <target name="compile" depends="prepare"
    description="--> Compile Tests">
    <javac srcdir="${src.dir}:${obj.dir}"
      destdir="${obj.dir}"
      debug="true"
      deprecation="${deprecation}"
      optimize="false"
      nowarn="${nowarn}"
      verbose="${verbose}">
      
      <classpath refid="project.class.path"/>

      <include name="org/objectweb/jtests/jms/**/*.java"/>

      <!-- Excludes CVS directories -->
      <exclude name="**/CVS/**/*.java"/>
    </javac>
  </target>

  <target name="compile.joram" depends="prepare.providers"
    description="--> Compile Joram specific classes">
    <javac srcdir="${src.dir}:${obj.dir}"
      destdir="${obj.dir}"
      debug="true"
      deprecation="${deprecation}"
      optimize="false"
      nowarn="${nowarn}"
      verbose="${verbose}">
      
      <classpath refid="project.class.path"/>

      <include name="org/objectweb/jtests/providers/admin/JoramAdmin.java"/>

      <!-- Excludes CVS directories -->
      <exclude name="**/CVS/**/*.java"/>
    </javac>
  </target>
 
  <target name="javadoc" depends="init"
    description="--> Generate Javadoc">
    <delete dir="${jdoc.dir}" />
    <mkdir dir="${jdoc.dir}" />
    <javadoc packagenames="org.objectweb.jtests.jms.*"
      sourcepath="${src.dir}"
      classpathref="project.class.path"
      defaultexcludes="yes"
      destdir="${jdoc.dir}"
      author="true"
      version="true"
      use="false"
      windowtitle="Test Suite Documentation">	   
      <doctitle><![CDATA[<h1>Test Suite 
        Documentation</h1>]]></doctitle>
      <group title="JMS Conformance Tests" packages="org.objectweb.jtests.jms.conform.*"/>
      <group title="JMS Administration" packages="org.objectweb.jtests.jms.admin"/>
      <group title="JMS JUnit Framework" packages="org.objectweb.jtests.jms.framework"/>
      <link href="http://java.sun.com/j2ee/sdk_1.3/techdocs/api/" />
      <link href="http://java.sun.com/j2se/1.3/docs/api/" />
      <link href="http://junit.org/junit/javadoc/3.7/" />
    </javadoc>
  </target>

  <target name="init.tests" depends="init">
    <delete dir="${test.dir}"/>
    <mkdir dir="${test.dir}"/>
    <path id="project.class.path">
      <path refid="base.class.path"/>
      <pathelement path="${obj.dir}"/>
      <pathelement path="${config.dir}"/>
      <fileset dir="${providers.dir}">
        <include name="**/*" />
      </fileset>
    </path>
  </target>

  <target name="batchtest" depends="init.tests,compile"
    description="--> Run all tests">
    <delete dir="${report.dir}" />
    <mkdir dir="${report.dir}" />
    <delete dir="${report.dir}/html" />
    <mkdir dir="${report.dir}/html" />
    <junit printsummary="yes" 
      haltonfailure="no"
      haltonerror="no"
      fork="yes" >
      <classpath refid="project.class.path" />
      <formatter type="xml" />
      <batchtest fork="yes" todir="${report.dir}">
        <fileset dir="${src.dir}">
          <include name="org/objectweb/jtests/jms/conform/**/*Test.java" />
        </fileset>
      </batchtest>
    </junit>
    <junitreport todir="${report.dir}">
      <fileset dir="${report.dir}">
	<include name="TEST-*.xml"/>
      </fileset>
      <report format="frames" todir="./report/html"/>
    </junitreport>
  </target>

  <target name="test" depends="init.tests,compile"
    description="--> Start one test (specified by -Dtest=&lt;class name&gt;)" >
    <mkdir dir="${report.dir}"  />
    <junit printsummary="yes" 
           haltonfailure="no"
	   haltonerror="no"
	   fork="yes" >
      <classpath refid="project.class.path" />
      <formatter type="xml" />
      <test name="${test}" todir="${report.dir}" />
    </junit>
    <junitreport todir="${report.dir}">
      <fileset dir="${report.dir}">
	<include name="TEST-*.xml"/>
      </fileset>
      <report format="frames" todir="./report/html"/>
    </junitreport>
  </target>

  <target name="junit.gui" depends="init.tests,compile"
    description="--> Use the GUI TestRunner of Junit">
    <java classname="junit.swingui.TestRunner"
      failonerror="no" fork="yes"
      dir="${test.dir}">
      <classpath refid="project.class.path"/>
    </java>    
  </target>

  <target name="package" depends="init, clean, compile, compile.joram,
    javadoc"
    description="--> Create a package for the test suite">
    <delete file="tests.tgz" />
    <tar tarfile="tests.tar"
      longfile="gnu"
      basedir=".."
      includes="tests/**"
      excludes="**/CVS, providers/fiorano/**"/>
    <gzip zipfile="tests.tgz" src="tests.tar" />
    <delete file="tests.tar" /> 
  </target>
</project>