<?xml version="1.0"?>

<!DOCTYPE project [
    <!ENTITY common SYSTEM "../common.xml">
]>

<project default="tests.all" basedir=".">
  <!-- Include generic part -->
  &common;

  <target name="init.src">
    <!-- Tests specific sources set -->
    <patternset id="specific">
      <include name="task/*.java"/>
      <exclude name="task/test12.java"/>
    </patternset>
  </target>

  <!-- test the task package -->
  <target name="tests.all">
    <ant dir="." antfile="build.xml" target="test1.task"/>
    <ant dir="." antfile="build.xml" target="test2.task"/>
    <ant dir="." antfile="build.xml" target="test3.task"/>
    <ant dir="." antfile="build.xml" target="test4.task"/>
    <ant dir="." antfile="build.xml" target="test5.task"/>
    <ant dir="." antfile="build.xml" target="test6.task"/>
    <ant dir="." antfile="build.xml" target="test7.task"/>
    <ant dir="." antfile="build.xml" target="test8.task"/>
    <ant dir="." antfile="build.xml" target="test9.task"/>
    <ant dir="." antfile="build.xml" target="test10.task"/>
    <ant dir="." antfile="build.xml" target="test11.task"/>
    <!-- ant dir="." antfile="build.xml" target="test12.task"/ -->
    <ant dir="." antfile="build.xml" target="test13.task"/>
  </target>

  <!--
    - Simple task tests
    -->
  <!-- Main to test the NotifyTask class -->
  <target name="test1.task" depends="compile">
    <antcall target="testx.task" inheritAll="true">
      <param name="x" value="1"/>
    </antcall>
  </target>

  <!-- Main to test the JavaMain classes -->
  <target name="test2.task" depends="compile">
    <antcall target="testx.task" inheritAll="true">
      <param name="x" value="2"/>
    </antcall>
  </target>

  <!-- Main to test the Program classes -->
  <target name="test3.task" depends="compile">
    <antcall target="testx.task" inheritAll="true">
      <param name="x" value="3"/>
    </antcall>
  </target>

  <!-- Main to test the Sequential class -->
  <target name="test4.task" depends="compile">
    <antcall target="testx.task" inheritAll="true">
      <param name="x" value="4"/>
    </antcall>
  </target>

  <!-- Main to test the Parallel class -->
  <target name="test5.task" depends="compile">
    <antcall target="testx.task" inheritAll="true">
      <param name="x" value="5"/>
    </antcall>
  </target>

  <!-- Main to test the ServiceTask class -->
  <target name="test6.task" depends="compile">
    <antcall target="testx.task" inheritAll="true">
      <param name="x" value="6"/>
    </antcall>
  </target>

  <!-- Main to test the Delegating class -->
  <target name="test7.task" depends="compile">
    <antcall target="testx.task" inheritAll="true">
      <param name="x" value="7"/>
    </antcall>
  </target>

  <!-- Main to test the IndexedCommand and IndexedReport classes -->
  <target name="test8.task" depends="compile">
    <antcall target="testx.task" inheritAll="true">
      <param name="x" value="8"/>
    </antcall>
  </target>

  <!-- Main to test the Program constructor with string array argument. -->
  <target name="test9.task" depends="compile">
    <antcall target="testx.task" inheritAll="true">
      <param name="x" value="9"/>
    </antcall>
  </target>

  <!-- Main to test a restart of a failed task -->
  <target name="test10.task" depends="compile" if="unix">
    <antcall target="testx.task" inheritAll="true">
      <param name="x" value="10"/>
    </antcall>
  </target>

  <!-- Main to test killing and restarting a task -->
  <target name="test11.task" depends="compile">
    <antcall target="testx.task" inheritAll="true">
      <param name="x" value="11"/>
    </antcall>
  </target>

  <!-- Main to test scheduling a task -->
  <target name="test12.task" depends="compile">
    <antcall target="testx.task" inheritAll="true">
      <param name="x" value="12"/>
    </antcall>
  </target>

  <!-- Main to test scheduling a task -->
  <target name="test13.task" depends="compile">
    <antcall target="testx.task" inheritAll="true">
      <param name="x" value="13"/>
    </antcall>
  </target>

  <!--
    - Generic test launcher
    -->

  <target name="init.test">
    <!-- Initialization of the run directory -->
    <delete dir="${test.dir}"/>
    <mkdir dir="${test.dir}"/>

    <copy file="${a3conf}" tofile="${test.dir}/a3servers.xml"/>
    <replace file="${test.dir}/a3servers.xml"
             token="@engine@" value="${engine}"/>
    <replace file="${test.dir}/a3servers.xml"
             token="@transaction@" value="${transaction}"/>
    <replace file="${test.dir}/a3servers.xml"
             token="@network@" value="${network}"/>

    <copy file="a3debug.cfg" tofile="${test.dir}/a3debug.cfg"/>
  </target>

  <target name="testx.task">
    <antcall target="init.test" inheritAll="true">
      <param name="a3conf" value="a3servers1.xml"/>
      <param name="a3debug" value="a3debug.cfg"/>
      <param name="engine" value="fr.dyade.aaa.agent.Engine"/>
      <param name="network" value="fr.dyade.aaa.agent.NGNetwork"/>
      <param name="transaction" value="fr.dyade.aaa.util.NTransaction"/>
    </antcall>
    <copy file="hello.sh" todir="${test.dir}"/>
    <java classname="task.test${x}"
          failonerror="no" fork="yes"
          dir="${test.dir}">
      <classpath path="${project.class.path}"/>
      <jvmarg value="-DTransaction=fr.dyade.aaa.util.NTransaction"/>
      <jvmarg value="-Dframework.TestCase.OutFile=${report.file}"/>
      <arg line="0 ./s0"/>
    </java>
  </target>

</project>
