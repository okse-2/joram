<?xml version="1.0"?>

<!DOCTYPE project [
    <!ENTITY common SYSTEM "file:../../common.xml">
]>

<project default="tests" basedir="..">

  <!--
    - Nortel Tests
    -->
  <target name="tests" depends="test.nortel"/>

  <target name="init.src">
    <!-- Tests specific sources set -->
    <patternset id="specific">
      <include name="joram/nortel/com/**/*.java"/>
    </patternset>
  </target>

  <!-- Include generic part -->
  &common;

  <target name="init.test.nortel" depends="init">
    <delete dir="${test.dir}"/>
    <mkdir dir="${test.dir}"/>
    <copy file="nortel/a3servers.xml" tofile="${test.dir}/a3servers.xml"/>
    <copy file="nortel/jndi.properties" tofile="${test.dir}/jndi.properties"/>
    <copy file="nortel/a3debug.cfg" tofile="${test.dir}/a3debug.cfg"/>
  </target>

  <target name="nortel.server.run" depends="init">
    <java classname="fr.dyade.aaa.agent.AgentServer"
        failonerror="no" fork="yes" maxmemory="256m"
        dir="${test.dir}">
      <classpath path="${project.class.path}"/>
      <jvmarg line="-Dcom.sun.management.jmxremote -DMXServer=com.scalagent.jmx.JMXServer"/>
      <arg line="0 ./s0"/>
    </java>
  </target>

  <target name="nortel.broker.run" depends="init">
    <java classname="com.nortel.oam.test3.broker.Broker"
        failonerror="no" fork="yes" maxmemory="256m"
        dir="${test.dir}">
      <classpath path="${project.class.path}"/>
      <jvmarg line="-Dcom.sun.management.jmxremote -DMXServer=com.scalagent.jmx.JMXServer"/>
      <arg line=""/>
    </java>
  </target>

  <target name="nortel.producer.debug" depends="init">
    <java classname="com.nortel.oam.test3.core.Producer"
        failonerror="no" fork="yes" maxmemory="256m"
        dir="${test.dir}">
      <classpath path="${project.class.path}"/>
      <jvmarg line="-Xdebug -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,server=y,suspend=y"/>
      <arg line=""/>
    </java>
  </target>

  <target name="nortel.producer.run" depends="init">
    <java classname="com.nortel.oam.test3.core.Producer"
        failonerror="no" fork="yes" maxmemory="256m"
        dir="${test.dir}">
      <classpath path="${project.class.path}"/>
      <jvmarg line=""/>
      <arg line=""/>
    </java>
  </target>

  <target name="nortel.consumer.run" depends="init">
    <java classname="com.nortel.oam.test3.core.Consumer"
        failonerror="no" fork="yes" maxmemory="256m"
        dir="${test.dir}">
      <classpath path="${project.class.path}"/>
      <jvmarg line=""/>
      <arg line=""/>
    </java>
  </target>

  <target name="test.nortel" depends="init.test.nortel">
    <parallel>
      <antcall target="nortel.broker.run" inheritAll="true"/>
      <sequential>
        <sleep seconds="5"/>
        <antcall target="nortel.producer.run" inheritAll="true"/>
      </sequential>
    </parallel>
  </target>

  <target name="test.nortel1" depends="init.test.nortel">
   <parallel>
      <antcall target="nortel.server.run" inheritAll="true"/>
      <sequential>
        <sleep seconds="5"/>
        <parallel>
          <antcall target="nortel.broker.run" inheritAll="true"/>
          <sequential>
            <sleep seconds="5"/>
            <antcall target="nortel.producer.run" inheritAll="true"/>
          </sequential>
        </parallel>
      </sequential>
    </parallel>
  </target>

</project>
